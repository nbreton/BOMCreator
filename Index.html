<!doctype html>
<html>
<head>
  <base target="_top">
  <?!= include('style'); ?>
</head>
<body>
  <div class="appShell">
    <header class="topbar">
      <div class="brand">
        <img id="logoCompany" class="logo" alt="Company logo">
        <div class="brandText">
          <div class="title">VERDON mBOM App</div>
          <div class="sub" id="sub">Loading…</div>
        </div>
      </div>

      <div class="actions">
        <div class="actionsRow">
          <div class="opStatus" title="Current operation">
            <div id="spinner" class="spinner"></div>
            <div id="opLabel">Idle</div>
          </div>
          <button class="iconbtn" id="btnRefreshAgile" title="Refresh Agile Index">↻</button>
          <button class="iconbtn" id="btnRefreshData" title="Refresh App Data">⟳</button>
          <button class="iconbtn" id="btnFullscreen" title="Fullscreen / Open Web App">⛶</button>
          <img id="logoCustomer" class="logo" alt="Customer logo">
        </div>
        <div id="opLine" class="opLine"></div>
      </div>
    </header>

    <div class="layout">
      <nav class="sidenav">
        <div class="navTitle">Navigation</div>
        <div class="tabs">
          <div class="tab active" data-page="dashboard">Dashboard</div>
          <div class="tab" data-page="createMbom">mBOM Creation</div>
          <div class="tab" data-page="monitoring">Copy Monitoring</div>
          <div class="tab" data-page="projectData">Project Data</div>
          <div class="tab" data-page="notifications">Notifications</div>
          <div class="tab" data-page="settings">Settings</div>
          <div class="tab" data-page="diagnostics">Diagnostics</div>
          <div class="tab" data-page="import">Import</div>
          <div class="tab" data-page="readme">README</div>
        </div>
      </nav>

      <main class="main">
        <div id="statusBanner" class="statusBanner" style="display:none;"></div>
        <!-- DASHBOARD -->
        <section class="page active" id="page-dashboard">
          <div class="pageTitle">
            <h2>Dashboard</h2>
            <p>Quick health and approval status across jobs, projects, and Agile inputs.</p>
          </div>

          <div class="subtabs">
            <div class="subtab active" data-sub="projects">Projects</div>
            <div class="subtab" data-sub="edit">Edit Projects</div>
            <div class="subtab" data-sub="forms">Form Library</div>
            <div class="subtab" data-sub="agile">Agile BOM</div>
            <div class="subtab" data-sub="approvals">Approvals</div>
          </div>

          <!-- Projects -->
          <div class="card" id="dash-projects">
            <div class="cardHeader">
              <h3>Projects (select to batch create RELEASED)</h3>
            </div>
            <div class="state" id="state-projects"></div>
            <div class="cardBody" id="body-projects">
              <div class="row row-split">
              <div class="btnGroup filters">
                <span class="btnGroupLabel">Filters</span>
                <button class="btn filter" id="btnSelectEligible">Select eligible (approved)</button>
                <button class="btn filter" id="btnClearSelection">Clear selection</button>
              </div>
                <div class="btnGroup actions">
                  <span class="btnGroupLabel">Actions</span>
                  <button class="btn primary" id="btnScheduleSelected">Schedule RELEASED for selected</button>
                  <button class="btn warn" id="btnScheduleAllEligible">Schedule RELEASED for ALL eligible</button>
                </div>
                <span class="mono" id="batchHint"></span>
              </div>
              <div class="row" style="margin-top:8px;">
                <span class="mono" id="projectsCount"></span>
              </div>

              <div class="tableWrap">
                <table class="table resizable" id="tblProjects">
                  <thead>
                    <tr>
                      <th></th>
                      <th>Project</th>
                      <th>Cluster Agile</th>
                      <th>MDA Agile</th>
                      <th>Latest RELEASED</th>
                      <th>Eligibility</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="toast mono" id="projectsHint"></div>
            </div>
          </div>

          <!-- Project edits -->
          <div class="card" id="dash-edit" style="display:none;">
            <div class="cardHeader">
              <h3>Project Edit (ClusterGroup, Busway Supplier)</h3>
            </div>
            <div class="state" id="state-edit"></div>
            <div class="cardBody" id="body-edit">
              <div class="banner">
                Update project-level overrides for ClusterGroup and Busway supplier in one place.
              </div>
              <div class="tableWrap compact">
                <table class="table resizable" id="tblProjectEdit">
                  <thead>
                    <tr>
                      <th>Project</th>
                      <th>ClusterGroup</th>
                      <th>Cluster Busway Supplier</th>
                      <th>MDA Busway Supplier</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Forms -->
          <div class="card" id="dash-forms" style="display:none;">
            <div class="cardHeader">
              <h3>Form Library (ECR/ACT for Form revisions)</h3>
            </div>
            <div class="state" id="state-forms"></div>
            <div class="cardBody" id="body-forms">
              <div class="banner">
                “Current Approved” is the Form file ID stored in CONFIG → CURRENT_APPROVED_FORM_FILE_ID.
                If REQUIRE_APPROVED_FORM=TRUE, RELEASED creation is blocked unless that Form is marked APPROVED.
              </div>
              <div class="row" style="margin-top:8px;">
                <div style="min-width:240px;">
                  <label>Search forms</label>
                  <input id="formsSearch" placeholder="Filter by rev, status, or file">
                </div>
                <div style="min-width:180px;">
                  <label>Status</label>
                  <select id="formsStatusFilter">
                    <option value="">All</option>
                    <option value="DRAFT">Draft</option>
                    <option value="APPROVED">Approved</option>
                    <option value="OBSOLETE">Obsolete</option>
                  </select>
                </div>
                <span class="mono" id="formsCount"></span>
              </div>
              <div class="tableWrap">
                <table class="table resizable" id="tblForms">
                  <thead>
                    <tr>
                      <th>Rev</th>
                      <th>Status</th>
                      <th>Current</th>
                      <th>File Name</th>
                      <th>File</th>
                      <th>Created</th>
                      <th>ECR/ACT Ref</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="row" style="margin-top:8px;" id="formsPager">
                <button class="btn" id="btnFormsPrev">Prev</button>
                <button class="btn" id="btnFormsNext">Next</button>
                <span class="mono" id="formsPageMeta"></span>
              </div>
            </div>
          </div>

          <!-- Agile -->
          <div class="card" id="dash-agile" style="display:none;">
            <div class="cardHeader">
              <h3>Agile BOM (latest per Site/Part)</h3>
            </div>
            <div class="state" id="state-agile"></div>
            <div class="cardBody" id="body-agile">
              <div class="tableWrap">
                <table class="table resizable" id="tblAgileLatest">
                  <thead>
                    <tr>
                      <th>Site</th>
                      <th>Part</th>
                      <th>Rev</th>
                      <th>Date</th>
                      <th>Tab</th>
                      <th>Busway Supplier</th>
                      <th>Approval</th>
                      <th>Action</th>
                    </tr>
                    <tr class="filterRow">
                      <th><select id="agileFilterSite"></select></th>
                      <th><select id="agileFilterPart"></select></th>
                      <th></th>
                      <th></th>
                      <th><input id="agileFilterTab" placeholder="Search tab"></th>
                      <th><select id="agileFilterBusway"></select></th>
                      <th><select id="agileFilterApproval"></select></th>
                      <th class="filterActions">
                        <button class="btn" id="btnAgileClearFilters">Clear filters</button>
                        <button class="btn" id="btnAgileToggleHistory">Show history</button>
                      </th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="row" style="margin-top:8px;" id="agilePager">
                <button class="btn" id="btnAgilePrev">Prev</button>
                <button class="btn" id="btnAgileNext">Next</button>
                <span class="mono" id="agilePageMeta"></span>
              </div>
              <div class="toast mono" id="agileHint"></div>

              <h3 style="margin-top:16px;">Agile BOM Reviews (pending)</h3>
              <table class="table resizable" id="tblAgileReviews">
                <thead>
                  <tr>
                    <th>Site</th>
                    <th>Part</th>
                    <th>Rev</th>
                    <th>Tab</th>
                    <th>Project Type</th>
                    <th>Issues</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Approvals -->
          <div class="card" id="dash-approvals" style="display:none;">
            <div class="cardHeader">
              <h3>Approvals Queue</h3>
            </div>
            <div class="state" id="state-approvals"></div>
            <div class="cardBody" id="body-approvals">
              <div class="banner" style="margin-top:10px;">
                Create RELEASED is disabled until required approvals are completed (Agile approvals, and Form approval if enforced).
              </div>

              <h3 style="margin-top:10px;">Agile approvals</h3>
              <table class="table resizable" id="tblPendingAgile">
                <thead>
                  <tr>
                    <th>Site</th>
                    <th>Part</th>
                    <th>Rev</th>
                    <th>Date</th>
                    <th>Tab</th>
                    <th>Busway Supplier</th>
                    <th>Approval</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

              <h3 style="margin-top:12px;">Agile BOM Reviews</h3>
              <table class="table resizable" id="tblPendingAgileReviews">
                <thead>
                  <tr>
                    <th>Site</th>
                    <th>Part</th>
                    <th>Rev</th>
                    <th>Tab</th>
                    <th>Project Type</th>
                    <th>Issues</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

              <h3 style="margin-top:12px;">Form approvals</h3>
              <table class="table resizable" id="tblPendingForms">
                <thead>
                  <tr>
                    <th>Rev</th>
                    <th>Status</th>
                    <th>File Name</th>
                    <th>File</th>
                    <th>Created</th>
                    <th>ECR/ACT Ref</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- MBOM CREATION -->
        <section class="page" id="page-createMbom">
          <div class="pageTitle">
            <h2>mBOM Creation</h2>
            <p>Schedule Form revisions and RELEASED copies from the same workspace.</p>
          </div>

          <div class="card">
            <div class="cardHeader">
              <h3>Schedule new mBOM Form revision (Copy Job)</h3>
            </div>
            <div class="state" id="state-create-form"></div>
            <div class="cardBody" id="body-create-form">
              <div class="banner">
                Form copy can take time. This action is scheduled and visible in “Copy Monitoring”.
                The previous Form revision is moved to “Obsolete”.
              </div>

              <div class="grid2">
                <div>
                  <label>Base Form (select or enter File ID)</label>
                  <select id="formBaseSelect"></select>
                  <input id="formBaseId" placeholder="If empty, uses CURRENT_APPROVED_FORM_FILE_ID">
                  <div class="mono" id="formBaseMeta"></div>
                  <div class="fieldError" id="formBaseError"></div>
                </div>
                <div>
                  <label>New Form Rev (number)</label>
                  <input id="formNewRev" placeholder="e.g., 4">
                  <div class="fieldError" id="formNewRevError"></div>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px;">
                <div>
                  <label>ECR/ACT Reference</label>
                  <input id="formChangeRef" placeholder="e.g., ECR-12345 or ACT-…">
                  <div class="fieldError" id="formChangeRefError"></div>
                </div>
                <div>
                  <label>Affected Items (optional)</label>
                  <input id="formAffected" placeholder="optional">
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Description</label>
                <textarea id="formDesc" placeholder="What changed and why"></textarea>
                <div class="fieldError" id="formDescError"></div>
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnScheduleForm">Schedule Form Revision</button>
              </div>

              <div class="toast" id="formOut" style="display:none;"></div>

              <div class="card" style="margin-top:16px;">
                <div class="cardHeader">
                  <h3>ECR / ACT Actions (selection panel)</h3>
                </div>
                <div class="cardBody">
                  <div class="row">
                    <button class="btn" id="btnLoadActions">Load Actions</button>
                    <span class="mono" id="actionsMeta"></span>
                  </div>
                  <div class="row actionsFilters">
                    <input id="actionFilter" placeholder="Filter actions by text" style="min-width:220px;">
                    <select id="actionFilterProject">
                      <option value="">All Projects</option>
                    </select>
                    <select id="actionFilterDiscipline">
                      <option value="">All Disciplines</option>
                    </select>
                    <select id="actionFilterStatus">
                      <option value="">All Statuses</option>
                    </select>
                    <select id="actionFilterSource">
                      <option value="">All Sources</option>
                    </select>
                    <button class="btn" id="btnClearActionFilters">Clear</button>
                  </div>
                  <div class="scrollTable actionsTable">
                    <table class="table resizable" id="tblActions" style="margin-top:10px;">
                      <thead>
                        <tr>
                          <th>Action NB</th>
                          <th>Action Title</th>
                          <th>Project</th>
                          <th>Work Package</th>
                          <th>Discipline</th>
                          <th>Status</th>
                          <th>Source</th>
                          <th>Pick</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:16px;">
            <div class="cardHeader">
              <h3>Schedule RELEASED mBOM (Copy Job)</h3>
            </div>
            <div class="state" id="state-create-released"></div>
            <div class="cardBody" id="body-create-released">
              <div class="banner" id="relBanner">
                Create RELEASED will be disabled until required approvals are satisfied (Agile + Form), depending on Settings.
              </div>

              <div class="grid2">
                <div>
                  <label>Project</label>
                  <select id="relProject"></select>
                  <div class="mono" id="relProjectMeta"></div>
                  <div class="fieldError" id="relProjectError"></div>
                </div>
                <div>
                  <label>mBOM Form (read-only selection)</label>
                  <select id="relFormSelect"></select>
                  <div class="mono" id="relFormMeta"></div>
                  <div class="fieldError" id="relFormError"></div>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px;">
                <div>
                  <label>Cluster Agile (Zone) revision</label>
                  <select id="relClusterTab"></select>
                  <div class="mono" id="relClusterMeta"></div>
                  <div class="fieldError" id="relClusterError"></div>
                </div>

                <div id="mdaBlock">
                  <label>MDA Agile revision (only for ClusterGroup = 1)</label>
                  <select id="relMdaTab"></select>
                  <div class="mono" id="relMdaMeta"></div>
                  <div class="fieldError" id="relMdaError"></div>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px;">
                <div>
                  <label>Busway Supplier (Cluster)</label>
                  <div class="mono" id="relClusterBusway"></div>
                  <div class="mono" id="relClusterBuswayCode"></div>
                </div>
                <div id="mdaBuswayBlock">
                  <label>Busway Supplier (MDA)</label>
                  <div class="mono" id="relMdaBusway"></div>
                  <div class="mono" id="relMdaBuswayCode"></div>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px;">
                <div>
                  <label>ECO (from Agile selection)</label>
                  <input id="relEco" disabled>
                </div>
                <div>
                  <label>Affected Items (optional)</label>
                  <input id="relAffected" placeholder="optional">
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Description</label>
                <textarea id="relDesc" placeholder="Release reason / summary"></textarea>
                <div class="fieldError" id="relDescError"></div>
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnScheduleReleased">Schedule RELEASED</button>
                <span class="mono" id="relControlMsg"></span>
              </div>

              <div class="toast" id="relOut" style="display:none;"></div>
            </div>
          </div>
        </section>

        <!-- COPY MONITORING -->
        <section class="page" id="page-monitoring">
          <div class="pageTitle">
            <h2>Copy Monitoring</h2>
            <p>Track queue activity and job results as background triggers run.</p>
          </div>
          <div class="card">
            <div class="cardHeader">
              <h3>Copy Monitoring (Jobs)</h3>
            </div>
            <div class="state" id="state-monitoring"></div>
            <div class="cardBody" id="body-monitoring">
              <div class="row">
                <button class="btn" id="btnRefreshJobs">Refresh jobs</button>
                <button class="btn warn" id="btnRestartJobs">Restart job runner</button>
                <label style="margin:0;">
                  <input type="checkbox" id="chkAutoJobs">
                  Auto-refresh while running
                </label>
              </div>

              <div class="row" style="margin-top:8px;">
                <div style="min-width:240px;">
                  <label>Search jobs</label>
                  <input id="jobsSearch" placeholder="Filter by job id, type, status">
                </div>
                <span class="mono" id="jobsCount"></span>
              </div>
              <div class="tableWrap">
                <table class="table resizable" id="tblJobs">
                  <thead>
                    <tr>
                      <th>Created</th>
                      <th>Type</th>
                      <th>Status</th>
                      <th>Progress</th>
                      <th>Message</th>
                      <th>Results</th>
                      <th>Errors</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <div class="toast mono" id="jobsHint"></div>
            </div>
          </div>
        </section>

        <!-- PROJECT DATA -->
        <section class="page" id="page-projectData">
          <div class="pageTitle">
            <h2>Project Data Explorer</h2>
            <p>Inspect Agile history and RELEASED versions for a selected project.</p>
          </div>
          <div class="card">
            <div class="cardHeader">
              <h3>Project Data Explorer</h3>
            </div>
            <div class="state" id="state-project-data"></div>
            <div class="cardBody" id="body-project-data">
              <div class="row">
                <div style="min-width:260px;">
                  <label>Project</label>
                  <select id="pdProject"></select>
                </div>
                <button class="btn primary" id="btnLoadProjectData">Load</button>
              </div>

              <div class="state" id="state-project-tree"></div>
              <div id="projectTree" style="margin-top:12px;"></div>
            </div>
          </div>
        </section>

        <!-- NOTIFICATIONS -->
        <section class="page" id="page-notifications">
          <div class="pageTitle">
            <h2>Notifications</h2>
            <p>Manage email recipients and digest timing for updates.</p>
          </div>
          <div class="card">
            <div class="cardHeader">
              <h3>Notification Settings</h3>
            </div>
            <div class="state" id="state-notifications"></div>
            <div class="cardBody" id="body-notifications">
              <div class="banner">
                Recipients and switches are stored in NOTIF_CONFIG.
                RELEASED notifications are grouped into digests over 4 hours (configurable).
              </div>

              <div class="toast mono" id="notifStatus"></div>

              <table class="table resizable" id="tblNotif">
                <thead>
                  <tr><th>Key</th><th>Value</th><th>Description</th></tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnSaveNotif">Save notification settings</button>
              </div>

              <div class="toast" id="notifOut" style="display:none;"></div>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section class="page" id="page-settings">
          <div class="pageTitle">
            <h2>Settings</h2>
            <p>Review configuration values and keep file indexes current.</p>
          </div>
          <div class="card">
            <div class="cardHeader">
              <h3>Configuration</h3>
            </div>
            <div class="state" id="state-settings"></div>
            <div class="cardBody" id="body-settings">
              <div class="toast mono" id="settingsHint"></div>

              <div class="row">
                <button class="btn" id="btnRefreshFiles">Refresh Files Index (Drive)</button>
                <button class="btn" id="btnRefreshDriveIndex">Refresh Drive Cache (chunked)</button>
              </div>

              <table class="table resizable" id="tblConfig">
                <thead>
                  <tr><th>Key</th><th>Value</th></tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnSaveConfig">Save configuration</button>
              </div>

              <div class="toast" id="cfgOut" style="display:none;"></div>
            </div>
          </div>
        </section>

        <!-- DIAGNOSTICS -->
        <section class="page" id="page-diagnostics">
          <div class="pageTitle">
            <h2>Diagnostics</h2>
            <p>Track request IDs and recent client-side errors.</p>
          </div>
          <div class="card">
            <div class="cardHeader">
              <h3>Diagnostics</h3>
            </div>
            <div class="state" id="state-diagnostics"></div>
            <div class="cardBody" id="body-diagnostics">
              <div class="banner">
                Quick visibility into the latest request IDs and recent client-side errors.
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="btn" id="btnBackfillAgileReviews">Backfill Agile BOM Reviews</button>
                <span class="mono" id="backfillAgileReviewsStatus"></span>
              </div>

              <div class="grid2" style="margin-top:10px;">
                <div>
                  <label>App version</label>
                  <div class="mono" id="diagVersion">—</div>
                </div>
                <div>
                  <label>Last requestId</label>
                  <div class="mono" id="diagRequestId">—</div>
                </div>
              </div>

              <h4 style="margin-top:16px;">Recent errors</h4>
              <table class="table resizable" id="tblDiagErrors">
                <thead>
                  <tr>
                    <th>When</th>
                    <th>Context</th>
                    <th>Message</th>
                    <th>Request</th>
                    <th>Stack</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- IMPORT -->
        <section class="page" id="page-import">
          <div class="pageTitle">
            <h2>Import RELEASED Files</h2>
            <p>Register legacy RELEASED mBOMs in the FILES table.</p>
          </div>
          <div class="card">
            <div class="cardHeader">
              <h3>Import previously created RELEASED mBOMs (integrate to FILES)</h3>
            </div>
            <div class="state" id="state-import"></div>
            <div class="cardBody" id="body-import">
              <div class="banner">
                Paste one per line:
                - File URL or File ID, OR
                - CSV: fileId,projectKey,rev,status
              </div>
              <label>Input</label>
              <textarea id="importText" placeholder="https://docs.google.com/spreadsheets/d/FILEID/edit
FILEID
FILEID,GRQ6A-2,3,RELEASED"></textarea>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="btnImport">Import</button>
              </div>

              <div class="toast" id="importOut" style="display:none;"></div>
            </div>
          </div>
        </section>

        <!-- README -->
        <section class="page" id="page-readme">
          <div class="pageTitle">
            <h2>README</h2>
            <p>Usage overview and operational reminders.</p>
          </div>
          <div class="card">
            <div class="cardHeader">
              <h3>README</h3>
            </div>
            <div class="state" id="state-readme"></div>
            <div class="cardBody" id="body-readme">
              <div class="toast" style="white-space:pre-wrap; line-height:1.45;">
This app manages:
- Agile BOM indexing + approvals
- mBOM Form revision control
- RELEASED mBOM creation per project
- Background copy monitoring (Jobs)
- Email notifications (Agile published / Form created / RELEASED digest)

Key rules:
- ClusterGroup = 1 => MDA required.
- ClusterGroup != 1 => MDA not used (MDA SheetName stays empty).
- If REQUIRE_APPROVED_FORM and/or REQUIRE_APPROVED_AGILE are TRUE:
  - RELEASED creation is blocked until Form and Agile approvals are satisfied.

Copy Monitoring:
- Form and RELEASED creation are scheduled as jobs.
- View progress in “Copy Monitoring” and in the Dashboard “Copy Jobs” card.

Notifications:
- Agile published (new latest): email to Engineering recipients.
- Form created: email to Engineering recipients.
- RELEASED created: digest to Ops recipients (grouped over 4 hours).
Configure in Notifications tab.

Import:
- Use Import tab to register older RELEASED files into FILES.
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div id="toastStack" class="toastStack" aria-live="polite" aria-atomic="true"></div>

<script>
  let BOOT = null;
  let cacheClusterRows = [];
  let cacheMdaRows = [];
  let changeActionsCache = [];
  const selectedActionRefs = new Set();
  let agileHistoryEnabled = false;
  let jobsPollTimer = null;
  let lastPollErrorAt = 0;
  const DIAG = {
    version: '',
    lastRequestId: '',
    recentErrors: []
  };
  const DIAG_MAX_ERRORS = 8;
  const TABLE_LIMITS = { forms: 200, agile: 300 };
  const LARGE_DATA_THRESHOLD = 1000;
  const formsPage = { offset: 0, limit: TABLE_LIMITS.forms, total: 0, server: false };
  const agilePage = { offset: 0, limit: TABLE_LIMITS.agile, total: 0, server: false };
  const filtersState = {
    forms: { query: '', status: '' },
    jobs: { query: '' }
  };
  const STATE_DEFAULTS = {
    loading: { icon: '⏳', title: 'Loading', body: 'Fetching the latest data.' },
    empty: { icon: '○', title: 'Nothing here yet', body: 'When data is available it will appear here.' },
    error: { icon: '⚠️', title: 'Something went wrong', body: 'Please retry or contact support.' }
  };

  function $(id){ return document.getElementById(id); }

  function setLogo(imgEl, url){
    const u = (url || '').trim();
    if (!u) { imgEl.style.display='none'; imgEl.src=''; return; }
    imgEl.src = u;
    imgEl.style.display = 'block';
  }

  function setBusy(on, label){
    $('spinner').style.display = on ? 'block' : 'none';
    $('opLine').style.display = on ? 'block' : 'none';
    $('opLabel').textContent = on ? (label || 'Working…') : 'Idle';
  }

  function setStatus(message, type){
    const banner = $('statusBanner');
    if (!message) {
      banner.style.display = 'none';
      banner.className = 'statusBanner';
      banner.textContent = '';
      return;
    }
    banner.textContent = message;
    banner.className = `statusBanner ${type || 'info'}`;
    banner.style.display = 'block';
  }

  function setState(id, state, overrides){
    const el = $(id);
    if (!el) return;
    if (!state || state === 'ready') {
      el.className = 'state';
      el.innerHTML = '';
      return;
    }
    const base = STATE_DEFAULTS[state] || {};
    const icon = overrides && overrides.icon ? overrides.icon : base.icon || '';
    const title = overrides && overrides.title ? overrides.title : base.title || '';
    const body = overrides && overrides.body ? overrides.body : base.body || '';
    el.className = `state active ${state}`;
    el.innerHTML = `
      <div class="stateIcon">${escapeHtml(icon)}</div>
      <div class="stateTitle">${escapeHtml(title)}</div>
      <div class="stateBody">${escapeHtml(body)}</div>
    `;
  }

  function setStateWithBody(stateId, bodyId, state, overrides){
    setState(stateId, state, overrides);
    const body = $(bodyId);
    if (!body) return;
    body.classList.toggle('is-hidden', !!state && state !== 'ready');
  }

  function setFieldError(inputId, errorId, message){
    const input = $(inputId);
    const errorEl = $(errorId);
    if (input) input.classList.toggle('inputError', !!message);
    if (errorEl) errorEl.textContent = message || '';
  }

  function clearFieldErrors(ids){
    (ids || []).forEach(pair => setFieldError(pair.input, pair.error, ''));
  }

  function actionRefKey_(row){
    return String(row?.actionNb || row?.actionTitle || '').trim();
  }

  function actionRowLink_(row){
    const ssId = String(row?.sourceSpreadsheetId || '').trim();
    const sheetId = String(row?.sourceSheetId || '').trim();
    const rowNum = String(row?.sourceRow || '').trim();
    if (!ssId || !sheetId || !rowNum) return '';
    return `https://docs.google.com/spreadsheets/d/${encodeURIComponent(ssId)}/edit#gid=${encodeURIComponent(sheetId)}&range=A${encodeURIComponent(rowNum)}`;
  }

  function updateSelectedActionRefs_(){
    $('formChangeRef').value = Array.from(selectedActionRefs.values()).join(' / ');
  }

  function setTableEmpty(tbody, colSpan, message){
    if (!tbody) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="${colSpan}" class="mono">${escapeHtml(message || 'No data available.')}</td>`;
    tbody.appendChild(tr);
  }

  function toast(type, message){
    const stack = $('toastStack');
    if (!stack) return;
    const item = document.createElement('div');
    item.className = `toastItem ${type || 'info'}`;
    item.innerHTML = `
      <div class="toastMessage">${escapeHtml(message || '')}</div>
      <button class="toastClose" aria-label="Dismiss">✕</button>
    `;
    const closeBtn = item.querySelector('.toastClose');
    closeBtn.addEventListener('click', () => item.remove());
    stack.appendChild(item);
    requestAnimationFrame(() => item.classList.add('show'));
    setTimeout(() => item.remove(), 6000);
  }

  function notifySuccess(message){
    toast('success', message);
  }

  function notifyError(context, err){
    const msg = context ? `${context}: ${formatErrorMessage(err)}` : formatErrorMessage(err);
    setStatus(msg, 'error');
    toast('error', msg);
    recordError(context, err);
    console.error('[mBOM] Error', context, err);
  }

  function normalizeResponse(res) {
    if (!res || typeof res !== 'object' || typeof res.ok !== 'boolean') {
      return {
        ok: false,
        error: {
          code: 'BAD_RESPONSE',
          message: 'Server returned an invalid response.',
          details: res || null,
          stackId: '',
          requestId: ''
        }
      };
    }
    if (res.ok === false && !res.error) {
      return {
        ok: false,
        error: { code: 'UNKNOWN', message: 'Server returned an error.', details: res || null, stackId: '', requestId: '' }
      };
    }
    return res;
  }

  function updateDiagnosticsFromResponse(res) {
    const meta = res && res.meta ? res.meta : {};
    if (meta.version) DIAG.version = meta.version;
    if (meta.requestId) DIAG.lastRequestId = meta.requestId;
    renderDiagnostics();
  }

  function recordError(context, err) {
    const entry = {
      ts: new Date().toISOString(),
      context: context || '',
      message: err && err.message ? err.message : String(err || 'Unknown error'),
      requestId: err && err.requestId ? err.requestId : (err && err.meta && err.meta.requestId ? err.meta.requestId : ''),
      stackId: err && err.stackId ? err.stackId : ''
    };
    DIAG.recentErrors.unshift(entry);
    if (DIAG.recentErrors.length > DIAG_MAX_ERRORS) {
      DIAG.recentErrors = DIAG.recentErrors.slice(0, DIAG_MAX_ERRORS);
    }
    renderDiagnostics();
  }

  function renderDiagnostics() {
    if ($('diagVersion')) $('diagVersion').textContent = DIAG.version || '—';
    if ($('diagRequestId')) $('diagRequestId').textContent = DIAG.lastRequestId || '—';

    const tbody = $('tblDiagErrors') ? $('tblDiagErrors').querySelector('tbody') : null;
    if (!tbody) return;
    tbody.innerHTML = '';
    if (!DIAG.recentErrors.length) {
      setState('state-diagnostics', 'empty', { title: 'No errors recorded', body: 'Client-side errors will show here if they occur.' });
      setTableEmpty(tbody, 5, 'No recent errors.');
      return;
    }
    setState('state-diagnostics', 'ready');
    DIAG.recentErrors.forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${escapeHtml(fmtDate(e.ts))}</td>
        <td>${escapeHtml(e.context || '')}</td>
        <td>${escapeHtml(e.message || '')}</td>
        <td class="mono">${escapeHtml(e.requestId || '—')}</td>
        <td class="mono">${escapeHtml(e.stackId || '—')}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function callApi(fn, payload) {
    return new Promise((resolve, reject) => {
      const runner = google.script.run.withSuccessHandler((res) => {
        const normalized = normalizeResponse(res);
        updateDiagnosticsFromResponse(normalized);
        if (!normalized.ok) {
          const err = new Error(normalized.error?.message || 'Request failed.');
          err.code = normalized.error?.code || 'ERROR';
          err.details = normalized.error?.details || null;
          err.stackId = normalized.error?.stackId || normalized.meta?.stackId || '';
          err.requestId = normalized.error?.requestId || normalized.meta?.requestId || '';
          reject(err);
          return;
        }
        resolve(normalized.data);
      }).withFailureHandler(err => {
        const msg = err && err.message ? err.message : String(err);
        const apiErr = new Error(`Request failed: ${msg}`);
        apiErr.code = 'SCRIPT_RUN_FAILED';
        apiErr.details = err || null;
        reject(apiErr);
      });

      if (payload === undefined) runner[fn]();
      else runner[fn](payload);
    });
  }

  function formatErrorMessage(err){
    const base = err && err.message ? err.message : String(err);
    const requestId = err && err.requestId ? ` (req ${err.requestId})` : '';
    const stackId = err && err.stackId ? ` (stack ${err.stackId})` : '';
    return `${base}${requestId}${stackId}`;
  }

  async function run(label, fn, payload){
    const DEBUG = (window.MBOM_DEBUG === true) || (localStorage.getItem('MBOM_DEBUG') === '1');
    const t0 = performance.now();

    if (DEBUG) {
      console.group(`[mBOM] CALL ${fn}`);
      console.log('label:', label);
      console.log('payload:', payload);
    }

    setStatus('', '');
    setBusy(true, label);

    try{
      const res = await callApi(fn, payload);

      if (DEBUG) {
        const dt = Math.round(performance.now() - t0);
        console.log('duration_ms:', dt);
        console.log('result_type:', typeof res);
        console.log('result:', res);

        // Best-effort size
        try {
          const s = JSON.stringify(res);
          console.log('result_json_length:', s.length);
        } catch(e) {
          console.log('result_json_length: (failed stringify)', e);
        }
        console.groupEnd();
      }

      return res;
    } catch(err){
      const msg = formatErrorMessage(err);
      setStatus(msg, 'error');
      if (DEBUG) {
        console.error(`[mBOM] CALL FAILED ${fn}`, err);
        console.groupEnd();
      }
      throw err;
    } finally {
      setBusy(false, '');
    }
  }


  function pill(status){
    const s = String(status||'').toUpperCase();
    if (s === 'APPROVED') return '<span class="pill ok">APPROVED</span>';
    if (s === 'REJECTED') return '<span class="pill bad">REJECTED</span>';
    if (s === 'CURRENT') return '<span class="pill blue">CURRENT</span>';
    if (s === 'CANCELLED') return '<span class="pill warn">CANCELLED</span>';
    if (s === 'OBSOLETE') return '<span class="pill gray">OBSOLETE</span>';
    if (s === 'DRAFT') return '<span class="pill blue">DRAFT</span>';
    if (s === 'RELEASED') return '<span class="pill ok">RELEASED</span>';
    if (s === 'RUNNING') return '<span class="pill blue">RUNNING</span>';
    if (s === 'QUEUED') return '<span class="pill warn">QUEUED</span>';
    if (s === 'DONE') return '<span class="pill ok">DONE</span>';
    if (s === 'DONE_WITH_ERRORS') return '<span class="pill warn">DONE W/ ERRORS</span>';
    if (s === 'ERROR') return '<span class="pill bad">ERROR</span>';
    if (!s) return '<span class="pill warn">UNSET</span>';
    return `<span class="pill warn">${escapeHtml(s)}</span>`;
  }

  function fileLink(url, label){
    if (!url) return '<span class="mono">—</span>';
    return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(label || 'Open')}</a>`;
  }

  function formatAgileTabName(tabName){
    const raw = String(tabName || '').trim();
    if (!raw) return '';
    const stripped = raw.replace(/\s+-\s+.*$/, '').replace(/\s+.*$/, '');
    const match = stripped.match(/^([A-Za-z0-9]+(?:-[A-Za-z0-9]+)*)/);
    if (match && match[1]) return match[1];
    return stripped || raw;
  }

  function agileTabLink(tabName, tabUrl){
    const label = formatAgileTabName(tabName);
    if (!label) return '<span class="mono">—</span>';
    if (!tabUrl) return `<span class="mono">${escapeHtml(label)}</span>`;
    return fileLink(tabUrl, label);
  }

  function confirmFileAction(title, details){
    const lines = Array.isArray(details) ? details.filter(Boolean) : [];
    const msg = `${title}\n\n${lines.join('\n')}\n\nConfirm? (Yes/No)`;
    return confirm(msg);
  }

  function getActivePageId(){
    const page = document.querySelector('.page.active');
    return page ? page.id : '';
  }

  function focusPrimarySearch(){
    const pageId = getActivePageId();
    if (pageId === 'page-dashboard') {
      const visibleDash = document.querySelector('.card:not([style*="display: none"]) input[id$="Search"]');
      if (visibleDash) { visibleDash.focus(); return true; }
      if ($('projectsSearch')) { $('projectsSearch').focus(); return true; }
    }
    if (pageId === 'page-monitoring' && $('jobsSearch')) { $('jobsSearch').focus(); return true; }
    return false;
  }

  function applyFormsFiltersClient_(rows){
    const q = String(filtersState.forms.query || '').trim().toLowerCase();
    const status = String(filtersState.forms.status || '').trim().toUpperCase();
    return (rows || []).filter(f => {
      if (status && String(f.status || '').toUpperCase() !== status) return false;
      if (!q) return true;
      const hay = [
        f.mbomRev, f.status, f.fileName, f.fileId, f.eco, f.description
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  function applyJobsFilters_(rows){
    const q = String(filtersState.jobs.query || '').trim().toLowerCase();
    if (!q) return rows || [];
    return (rows || []).filter(j => {
      const hay = [
        j.id, j.type, j.status, j.message
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  function fmtDate(iso){
    if (!iso) return '';
    try{
      const d = new Date(iso);
      if (isNaN(d.getTime())) return String(iso);
      return d.toLocaleString();
    }catch(e){ return String(iso); }
  }

  // Tabs navigation
  document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', async () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const page = t.dataset.page;
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      $('page-' + page).classList.add('active');

      if (page === 'monitoring') {
        await loadSections(['jobs'], 'Loading jobs…');
        await refreshJobs();
      }
      if (page === 'createMbom') await loadSections(['forms'], 'Loading forms…');
      if (page === 'settings') await loadSections(['config'], 'Loading settings…');
      if (page === 'notifications') await loadSections(['notifications'], 'Loading notifications…');
      if (page === 'diagnostics') renderDiagnostics();
    });
  });

  // Dashboard subtabs
  document.querySelectorAll('.subtab').forEach(st => {
    st.addEventListener('click', async () => {
      document.querySelectorAll('.subtab').forEach(x => x.classList.remove('active'));
      st.classList.add('active');

      const sub = st.dataset.sub;
      $('dash-projects').style.display = (sub === 'projects') ? '' : 'none';
      $('dash-edit').style.display = (sub === 'edit') ? '' : 'none';
      $('dash-forms').style.display = (sub === 'forms') ? '' : 'none';
      $('dash-agile').style.display = (sub === 'agile') ? '' : 'none';
      $('dash-approvals').style.display = (sub === 'approvals') ? '' : 'none';

      if (sub === 'forms') await loadSections(['forms'], 'Loading forms…');
      if (sub === 'edit') await loadSections(['projects'], 'Loading projects…');
      if (sub === 'agile') await loadSections(['agileLatest', 'approvals'], 'Loading Agile BOM…');
      if (sub === 'approvals') await loadSections(['approvals'], 'Loading approvals…');
    });
  });

  $('btnRefreshAgile').addEventListener('click', async () => {
    try {
      await run('Refreshing Agile Index…', 'api_refreshAgileIndex');
      await bootstrap();
      notifySuccess('Agile index refreshed.');
    } catch(e){
      notifyError('Agile refresh failed', e);
    }
  });

  $('btnRefreshData').addEventListener('click', async () => {
    try {
      await bootstrap();
      notifySuccess('App data refreshed.');
    } catch(e){
      notifyError('App refresh failed', e);
    }
  });

  const backfillBtn = $('btnBackfillAgileReviews');
  if (backfillBtn) {
    backfillBtn.addEventListener('click', async () => {
      const status = $('backfillAgileReviewsStatus');
      if (status) status.textContent = '';
      const includeHistory = confirm('Include historical Agile tabs in the backfill? Click OK for ALL tabs, Cancel for latest only.');
      try {
        const res = await run('Backfilling Agile reviews…', 'api_backfillAgileReviews', { includeHistory });
        const msg = `Backfill complete. Created ${res.created || 0}, Updated ${res.updated || 0}.`;
        if (status) status.textContent = msg;
        notifySuccess(msg);
        await reloadSections(['approvals'], 'Refreshing approvals…');
      } catch (e) {
        notifyError('Backfill failed', e);
      }
    });
  }

  $('btnFullscreen').addEventListener('click', async () => {
    try{
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    } catch(e){
      if (BOOT && BOOT.webAppUrl) window.open(BOOT.webAppUrl, '_blank');
      else alert('Fullscreen may be blocked in this window. Deploy as Web App to open in full tab.');
    }
  });

  $('btnRefreshAgile').title = 'Refresh Agile Index (Alt+Shift+A)';
  $('btnRefreshData').title = 'Refresh App Data (Alt+Shift+D)';
  $('btnFullscreen').title = 'Fullscreen / Open Web App (Alt+Shift+F)';
  if ($('btnRefreshDriveIndex')) $('btnRefreshDriveIndex').title = 'Refresh Drive cache (background job)';


  $('formBaseSelect').addEventListener('change', updateFormBaseMeta);
  $('relFormSelect').addEventListener('change', async () => {
    updateReleaseFormMeta();
    await updateControlledReleaseMsg();
  });

  $('btnRefreshFiles').addEventListener('click', async () => {
    try{
      const res = await run('Refreshing Files Index…', 'api_refreshFilesIndex');
      notifySuccess(`Files indexed. Inserted: ${res.inserted}, Updated: ${res.updated}.`);
      await bootstrap();
    } catch(e){
      notifyError('Files refresh failed', e);
    }
  });

  $('btnRefreshDriveIndex').addEventListener('click', async () => {
    try{
      const res = await run('Refreshing Drive cache…', 'api_refreshDriveIndex', { pageSize: 200 });
      notifySuccess(`Drive cache refresh scheduled (Job ${res.jobId}).`);
      switchTo('monitoring');
      await refreshJobs();
    } catch(e){
      notifyError('Drive cache refresh failed', e);
    }
  });

  // Create Form -> schedule
  $('btnScheduleForm').addEventListener('click', async () => {
    const out = $('formOut');
    out.style.display='block';
    out.textContent = 'Scheduling…';
    try{
      clearFieldErrors([
        { input: 'formBaseId', error: 'formBaseError' },
        { input: 'formNewRev', error: 'formNewRevError' },
        { input: 'formChangeRef', error: 'formChangeRefError' },
        { input: 'formDesc', error: 'formDescError' }
      ]);
      const baseId = $('formBaseId').value.trim() || (BOOT.config.currentApprovedFormFileId || '').trim();
      const newRev = Number($('formNewRev').value.trim());
      const desc = $('formDesc').value.trim();
      let hasError = false;
      if (!baseId) {
        setFieldError('formBaseId', 'formBaseError', 'Base Form ID is required (select or set current approved form).');
        hasError = true;
      }
      if (!isFinite(newRev) || newRev <= 0) {
        setFieldError('formNewRev', 'formNewRevError', 'Enter a valid revision number (positive integer).');
        hasError = true;
      }
      if (!desc) {
        setFieldError('formDesc', 'formDescError', 'Add a short description for tracking.');
        hasError = true;
      }
      if (hasError) {
        out.textContent = 'Fix validation errors above.';
        return;
      }
      const payload = {
        baseFormFileId: baseId,
        newFormRev: newRev,
        ecrActRef: $('formChangeRef').value.trim(),
        affectedItems: $('formAffected').value.trim(),
        description: desc
      };
      const ok = confirmFileAction('Schedule Form revision copy?', [
        `Base Form ID: ${payload.baseFormFileId || '—'}`,
        `New Revision: ${payload.newFormRev || '—'}`,
        `Change Ref: ${payload.ecrActRef || '—'}`,
        `Affected Items: ${payload.affectedItems || '—'}`,
        `Description: ${payload.description || '—'}`
      ]);
      if (!ok) {
        out.textContent = 'Cancelled.';
        return;
      }
      const res = await run('Scheduling Form copy…', 'api_scheduleFormRevision', payload);
      out.innerHTML = `Scheduled Job: <span class="mono">${escapeHtml(res.jobId)}</span>. Track it in “Copy Monitoring”.`;
      notifySuccess(`Form revision scheduled (Job ${res.jobId}).`);
      switchTo('monitoring');
      await refreshJobs();
    } catch(e){
      out.innerHTML = `<span style="color:var(--red)">Error:</span> ${escapeHtml(e.message || e)}`;
      notifyError('Schedule form failed', e);
    }
  });

  $('btnLoadActions').addEventListener('click', async () => {
    $('actionsMeta').textContent = 'Loading actions…';
    try {
      const res = await run('Loading actions…', 'api_listChangeActions');
      changeActionsCache = Array.isArray(res.actions) ? res.actions : [];
      if (res.warning) {
        $('actionsMeta').textContent = res.warning;
      } else {
        $('actionsMeta').textContent = `Loaded ${changeActionsCache.length} actions from ${res.sources?.length || 0} sheet(s).`;
      }
      updateActionFilters(changeActionsCache);
      renderChangeActions(changeActionsCache);
    } catch (e) {
      $('actionsMeta').textContent = 'Failed to load actions.';
      notifyError('Load actions failed', e);
    }
  });

  ['actionFilter', 'actionFilterProject', 'actionFilterDiscipline', 'actionFilterStatus', 'actionFilterSource']
    .forEach(id => {
      const el = $(id);
      if (!el) return;
      el.addEventListener('input', () => renderChangeActions(changeActionsCache));
      el.addEventListener('change', () => renderChangeActions(changeActionsCache));
    });

  $('btnClearActionFilters').addEventListener('click', () => {
    $('actionFilter').value = '';
    $('actionFilterProject').value = '';
    $('actionFilterDiscipline').value = '';
    $('actionFilterStatus').value = '';
    $('actionFilterSource').value = '';
    renderChangeActions(changeActionsCache);
  });

  // Create Released -> schedule
  $('btnScheduleReleased').addEventListener('click', async () => {
    const out = $('relOut');
    out.style.display='block';
    out.textContent = 'Scheduling…';
    try{
      const p = currentProject();
      if (!p) throw new Error('Invalid project selection');

      const includeMda = !!p.includeMda;

      clearFieldErrors([
        { input: 'relProject', error: 'relProjectError' },
        { input: 'relFormSelect', error: 'relFormError' },
        { input: 'relClusterTab', error: 'relClusterError' },
        { input: 'relMdaTab', error: 'relMdaError' },
        { input: 'relDesc', error: 'relDescError' }
      ]);
      let hasError = false;
      if (!p.projectKey) {
        setFieldError('relProject', 'relProjectError', 'Select a project to continue.');
        hasError = true;
      }
      const selectedFormId = $('relFormSelect').value || BOOT.config.currentApprovedFormFileId || '';
      if (BOOT.config.requireApprovedForm) {
        const form = (BOOT.forms || []).find(f => String(f.fileId || '').trim() === String(selectedFormId || '').trim());
        if (!selectedFormId) {
          setFieldError('relFormSelect', 'relFormError', 'Select an approved Form revision.');
          hasError = true;
        } else if (!form || String(form.status || '').toUpperCase() !== 'APPROVED') {
          setFieldError('relFormSelect', 'relFormError', 'Selected Form is not approved.');
          hasError = true;
        }
      }
      if (!$('relClusterTab').value) {
        setFieldError('relClusterTab', 'relClusterError', 'Select a Cluster Agile tab.');
        hasError = true;
      }
      if (includeMda && !$('relMdaTab').value) {
        setFieldError('relMdaTab', 'relMdaError', 'Select an MDA Agile tab.');
        hasError = true;
      }
      if (!$('relDesc').value.trim()) {
        setFieldError('relDesc', 'relDescError', 'Add a short description for tracking.');
        hasError = true;
      }
      if (hasError) {
        out.textContent = 'Fix validation errors above.';
        return;
      }

      const payload = {
        projectKey: p.projectKey,
        includeMda,
        freezeAgileInputs: true,
        approvedFormFileId: selectedFormId || '',
        agileTabCluster: $('relClusterTab').value,
        agileTabMDA: includeMda ? $('relMdaTab').value : '',
        eco: $('relEco').value.trim(),
        affectedItems: $('relAffected').value.trim(),
        description: $('relDesc').value.trim()
      };
      const ok = confirmFileAction('Schedule RELEASED mBOM copy?', [
        `Project: ${payload.projectKey}`,
        `Cluster Agile: ${formatAgileTabName(payload.agileTabCluster) || '—'}`,
        `MDA Agile: ${includeMda ? (formatAgileTabName(payload.agileTabMDA) || '—') : 'Not required'}`,
        `Freeze Agile Inputs: ${payload.freezeAgileInputs ? 'YES' : 'NO'}`,
        `Approved Form ID: ${payload.approvedFormFileId || '—'}`,
        `ECO: ${payload.eco || '—'}`,
        `Affected Items: ${payload.affectedItems || '—'}`,
        `Description: ${payload.description || '—'}`
      ]);
      if (!ok) {
        out.textContent = 'Cancelled.';
        return;
      }

      const res = await run('Scheduling RELEASED copy…', 'api_scheduleReleasedForProject', payload);
      out.innerHTML = `Scheduled Job: <span class="mono">${escapeHtml(res.jobId)}</span>. Track it in “Copy Monitoring”.`;
      notifySuccess(`RELEASED scheduled (Job ${res.jobId}).`);
      switchTo('monitoring');
      await refreshJobs();
    } catch(e){
      out.innerHTML = `<span style="color:var(--red)">Error:</span> ${escapeHtml(e.message || e)}`;
      notifyError('Schedule RELEASED failed', e);
    }
  });

  // Import
  $('btnImport').addEventListener('click', async () => {
    const out = $('importOut');
    out.style.display='block';
    out.textContent = 'Importing…';
    try{
      const res = await run('Importing files…', 'api_importReleased', { text: $('importText').value });
      out.innerHTML = `<div class="mono">Imported: ${escapeHtml(res.imported)} • Skipped: ${escapeHtml(res.skipped)} • Errors: ${escapeHtml(res.errors.length)}</div>
        <div class="mono">${(res.errors||[]).slice(0,10).map(e=>`• ${escapeHtml(e)}`).join('<br>')}</div>`;
      notifySuccess(`Import complete. Imported ${res.imported}, skipped ${res.skipped}.`);
      await bootstrap();
    } catch(e){
      out.innerHTML = `<span style="color:var(--red)">Error:</span> ${escapeHtml(e.message || e)}`;
      notifyError('Import failed', e);
    }
  });

  // Notifications save
  $('btnSaveNotif').addEventListener('click', async () => {
    const out = $('notifOut');
    out.style.display='block';
    out.textContent = 'Saving…';
    try{
      const updates = {};
      $('tblNotif').querySelectorAll('input[data-key]').forEach(inp => updates[inp.dataset.key] = inp.value);
      const res = await run('Saving notifications…', 'api_updateNotifSettings', { updates });
      out.innerHTML = `Saved. Updated keys: ${escapeHtml(res.updated)}`;
      notifySuccess('Notification settings saved.');
      await bootstrap();
    } catch(e){
      out.innerHTML = `<span style="color:var(--red)">Error:</span> ${escapeHtml(e.message || e)}`;
      notifyError('Saving notifications failed', e);
    }
  });

  // Settings save
  $('btnSaveConfig').addEventListener('click', async () => {
    const out = $('cfgOut');
    out.style.display='block';
    out.textContent = 'Saving…';
    try{
      const updates = {};
      $('tblConfig').querySelectorAll('input[data-key]').forEach(inp => updates[inp.dataset.key] = inp.value);
      const res = await run('Saving configuration…', 'api_updateConfig', { updates });
      out.innerHTML = `Saved. Updated keys: ${escapeHtml(res.updated)}`;
      notifySuccess('Configuration saved.');
      await bootstrap();
    } catch(e){
      out.innerHTML = `<span style="color:var(--red)">Error:</span> ${escapeHtml(e.message || e)}`;
      notifyError('Saving configuration failed', e);
    }
  });

  // Monitoring refresh
  $('btnRefreshJobs').addEventListener('click', refreshJobs);
  $('btnRestartJobs').addEventListener('click', async () => {
    if (!confirm('Restart the job runner trigger?')) return;
    try{
      await run('Restarting job runner…', 'api_restartJobs', {});
      await refreshJobs();
      notifySuccess('Job runner restarted.');
    } catch(e){
      notifyError('Restart failed', e);
    }
  });

  // Project Data
  $('btnLoadProjectData').addEventListener('click', async () => {
    const pk = $('pdProject').value;
    setState('state-project-tree', 'loading', { title: 'Loading project data', body: 'Fetching latest project details.' });
    $('projectTree').innerHTML = '';
    try{
      const res = await run('Loading project data…', 'api_getProjectData', { projectKey: pk });
      if (!res) throw new Error('api_getProjectData returned empty/invalid response.');
      renderProjectTree(res);
      notifySuccess('Project data loaded.');
    } catch(e){
      $('projectTree').innerHTML = '';
      setState('state-project-tree', 'error', { title: 'Unable to load project data', body: formatErrorMessage(e) });
      notifyError('Loading project data failed', e);
    }
  });


  // Batch selection controls
  $('btnClearSelection').addEventListener('click', () => {
    document.querySelectorAll('input[data-projchk]').forEach(c => c.checked = false);
  });

  $('btnSelectEligible').addEventListener('click', () => {
    const projects = BOOT.dashboard.projects || [];
    projects.forEach(p => {
      const ok = computeEligibility(p);
      const el = document.querySelector(`input[data-projchk="${p.projectKey}"]`);
      if (el) el.checked = ok;
    });
  });

  $('btnScheduleSelected').addEventListener('click', async () => {
    try{
      const selected = Array.from(document.querySelectorAll('input[data-projchk]:checked')).map(x => x.dataset.projchk);
      if (!selected.length) {
        toast('warn', 'No projects selected.');
        return;
      }
      const ok = confirmFileAction('Schedule RELEASED for selected projects?', [
        `Projects: ${selected.join(', ')}`,
        `Count: ${selected.length}`,
        `Freeze Agile Inputs: ${BOOT.config.freezeDefault === true ? 'YES' : 'NO'}`
      ]);
      if (!ok) return;

      const res = await run('Scheduling batch RELEASED…', 'api_scheduleReleasedForSelected', {
        projectKeys: selected,
        onlyEligible: false,
        freezeAgileInputs: (BOOT.config.freezeDefault === true),
        batchSize: 3,
        description: 'Batch RELEASED creation (selected projects)'
      });

      notifySuccess(`Scheduled batch RELEASED (Job ${res.jobId}).`);
      switchTo('monitoring');
      await refreshJobs();
    } catch(e){
      notifyError('Batch schedule failed', e);
    }
  });

  $('btnScheduleAllEligible').addEventListener('click', async () => {
    try{
      const ok = confirmFileAction('Schedule RELEASED for ALL eligible projects?', [
        'Projects: Eligible only (approved)',
        `Freeze Agile Inputs: ${BOOT.config.freezeDefault === true ? 'YES' : 'NO'}`
      ]);
      if (!ok) return;
      const res = await run('Scheduling ALL eligible RELEASED…', 'api_scheduleReleasedForAll', {
        onlyEligible: true,
        freezeAgileInputs: (BOOT.config.freezeDefault === true),
        batchSize: 3,
        description: 'Batch RELEASED creation (all eligible approved projects)'
      });
      notifySuccess(`Scheduled all eligible RELEASED (Job ${res.jobId}).`);
      switchTo('monitoring');
      await refreshJobs();
    } catch(e){
      notifyError('Schedule failed', e);
    }
  });

  ['formsSearch', 'formsStatusFilter'].forEach(id => {
    const el = $(id);
    if (!el) return;
    el.addEventListener('input', () => refreshForms());
    el.addEventListener('change', () => refreshForms());
  });

  $('btnFormsPrev')?.addEventListener('click', () => loadFormsPage(formsPage.offset - formsPage.limit));
  $('btnFormsNext')?.addEventListener('click', () => loadFormsPage(formsPage.offset + formsPage.limit));

  $('btnAgilePrev')?.addEventListener('click', () => loadAgilePage(agilePage.offset - agilePage.limit));
  $('btnAgileNext')?.addEventListener('click', () => loadAgilePage(agilePage.offset + agilePage.limit));

  $('jobsSearch')?.addEventListener('input', () => renderJobsTable(BOOT.jobs?.recent || []));

  // Create RELEASED selectors
  $('relProject').addEventListener('change', refreshReleaseSelectors);
  $('relClusterTab').addEventListener('change', async () => { updateAgileMeta(); updateBuswaySuggestions(); updateEcoSummary(); await updateControlledReleaseMsg(); });
  $('relMdaTab').addEventListener('change', async () => { updateAgileMeta(); updateBuswaySuggestions(); updateEcoSummary(); await updateControlledReleaseMsg(); });
  ['agileFilterSite', 'agileFilterPart', 'agileFilterTab', 'agileFilterBusway', 'agileFilterApproval']
    .forEach(id => {
      const el = $(id);
      if (!el) return;
      const handler = () => {
        if (agileShouldUseServer_()) loadAgilePage(0);
        else renderAgileLatest(getAgileRowsForDisplay_());
      };
      el.addEventListener('input', handler);
      el.addEventListener('change', handler);
    });
  $('btnAgileClearFilters').addEventListener('click', () => {
    $('agileFilterSite').value = '';
    $('agileFilterPart').value = '';
    $('agileFilterTab').value = '';
    $('agileFilterBusway').value = '';
    $('agileFilterApproval').value = '';
    if (agileShouldUseServer_()) loadAgilePage(0);
    else renderAgileLatest(getAgileRowsForDisplay_());
  });
  $('btnAgileToggleHistory').addEventListener('click', async () => {
    agileHistoryEnabled = !agileHistoryEnabled;
    $('btnAgileToggleHistory').textContent = agileHistoryEnabled ? 'Show latest only' : 'Show history';
    if (agileHistoryEnabled && !BOOT.loaded?.agileAll && !agileShouldUseServer_()) {
      await loadSections(['agileAll'], 'Loading Agile BOM history…');
    }
    if (agileShouldUseServer_()) {
      await loadAgilePage(0);
    } else {
      renderAgileLatest(getAgileRowsForDisplay_());
    }
  });

  function switchTo(page){
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelector(`.tab[data-page="${page}"]`).classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    $('page-' + page).classList.add('active');
  }

  function currentProject(){
    const pk = $('relProject').value;
    return (BOOT.dashboard.projects || []).find(x => x.projectKey === pk) || null;
  }

  function computeEligibility(p){
    // Client-side visibility. Server still enforces.
    if (BOOT.config.requireApprovedForm && !BOOT.dashboard.latestApprovedForm) return false;
    if (BOOT.config.requireApprovedAgile) {
      if (String(p.clusterApproval||'').toUpperCase() !== 'APPROVED') return false;
      if (p.includeMda && String(p.mdaApproval||'').toUpperCase() !== 'APPROVED') return false;
    }
    return true;
  }

  function renderJobsTop(){
    if (!$('jobsSummary') || !$('jobsRunning')) return;
    if (!BOOT || !BOOT.jobs || !BOOT.jobs.summary) {
      setStateWithBody('state-jobs', 'body-jobs', 'loading', { title: 'Loading jobs', body: 'Pulling current queue status.' });
      return;
    }
    setStateWithBody('state-jobs', 'body-jobs', 'ready');
    const s = BOOT.jobs.summary;
    $('jobsSummary').textContent = `Queued: ${s.queued} • Running: ${s.running} • Done: ${s.done} • Done(w/Errors): ${s.doneWithErrors} • Error: ${s.error}`;

    const running = BOOT.jobs.runningJob;
    if (!running) {
      $('jobsRunning').innerHTML = '<span class="mono">No running job.</span>';
      return;
    }

    const pct = running.progressTotal ? Math.round((running.progressCurrent / running.progressTotal) * 100) : 0;

    $('jobsRunning').innerHTML = `
      <div class="mono">Running: ${escapeHtml(running.type)} • ${escapeHtml(running.status)} • ${running.progressCurrent}/${running.progressTotal} • ${escapeHtml(running.message || '')}</div>
      <div class="bar" style="margin-top:6px;"><div style="width:${pct}%;"></div></div>
    `;
  }

  async function refreshJobs(){
    try{
      setState('state-monitoring', 'loading', { title: 'Refreshing jobs', body: 'Fetching latest job statuses.' });
      const res = await callApi('api_listJobs', { limit: 50, activeOnly: false });
      renderJobsTable(res.jobs || []);
      // also refresh header card without full bootstrap
      BOOT.jobs.summary = res.summary?.summary || {};
      BOOT.jobs.runningJob = res.summary?.runningJob || null;
      renderJobsTop();
    } catch(e) {
      setState('state-monitoring', 'error', { title: 'Unable to refresh jobs', body: formatErrorMessage(e) });
      notifyError('Job refresh failed', e);
      throw e;
    }
  }

  function renderJobsTable(jobs){
    const tbody = $('tblJobs').querySelector('tbody');
    tbody.innerHTML = '';
    $('jobsHint').textContent = 'Jobs run sequentially. Status updates as background triggers execute.';

    const filteredJobs = applyJobsFilters_(jobs || []);
    $('jobsCount').textContent = `${filteredJobs.length} job(s)`;

    if (!filteredJobs || !filteredJobs.length) {
      setState('state-monitoring', 'empty', { title: 'No jobs yet', body: 'Schedule a Form or RELEASED job to see activity.' });
      setTableEmpty(tbody, 8, 'No jobs found.');
      return;
    }
    setState('state-monitoring', 'ready');

    filteredJobs.forEach(j => {
      const pct = j.progressTotal ? Math.round((j.progressCurrent / j.progressTotal) * 100) : 0;
      const resultsHtml = (j.results || []).map(r => {
        if (r.url && r.name) return `<div class="mono">${fileLink(r.url, r.name)}</div>`;
        if (r.url) return `<div class="mono">${fileLink(r.url, 'Open')}</div>`;
        if (r.projectKey && r.url) return `<div class="mono">${escapeHtml(r.projectKey)}: ${fileLink(r.url,'Open')}</div>`;
        return `<div class="mono">${escapeHtml(JSON.stringify(r))}</div>`;
      }).join('');

      const errorsHtml = (j.errors || []).map(e => {
        const prefix = e.projectKey ? `${escapeHtml(e.projectKey)}: ` : '';
        const errMsg = escapeHtml(e.error || '');
        return `<div class="mono" style="color:var(--red)">• ${prefix}${errMsg}</div>`;
      }).join('');
      const statusUpper = String(j.status || '').toUpperCase();
      const cancelBtn = (['QUEUED', 'RUNNING'].includes(statusUpper))
        ? `<button class="btn warn" data-act="cancelJob" data-id="${j.id}">Cancel</button>`
        : '';
      const retryBtn = (['ERROR','DONE_WITH_ERRORS'].includes(statusUpper))
        ? `<button class="btn" data-act="retryJob" data-id="${j.id}">Retry</button>`
        : '';
      const removeBtn = (['QUEUED', 'RUNNING'].includes(statusUpper))
        ? '<span class="mono">—</span>'
        : `<button class="btn warn" data-act="removeJob" data-id="${j.id}">Remove</button>`;
      const actionsHtml = [cancelBtn, retryBtn, removeBtn].filter(Boolean).join(' ');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${escapeHtml(fmtDate(j.createdAt))}</td>
        <td class="mono">${escapeHtml(j.type)}</td>
        <td>${pill(j.status)}</td>
        <td>
          <div class="mono">${j.progressCurrent}/${j.progressTotal} (${pct}%)</div>
          <div class="bar"><div style="width:${pct}%;"></div></div>
        </td>
        <td class="mono">${escapeHtml(j.message || '')}</td>
        <td>${resultsHtml || '<span class="mono">—</span>'}</td>
        <td>${errorsHtml || '<span class="mono">—</span>'}</td>
        <td>${actionsHtml}</td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button[data-act="retryJob"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        try{
          await run('Retrying job…', 'api_retryJob', { jobId: btn.dataset.id });
          notifySuccess('Job retry scheduled.');
          await refreshJobs();
        } catch(e){
          notifyError('Retry failed', e);
        }
      });
    });

    tbody.querySelectorAll('button[data-act="cancelJob"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Cancel this job? This will stop future steps.')) return;
        try{
          await run('Cancelling job…', 'api_cancelJob', { jobId: btn.dataset.id });
          notifySuccess('Job cancellation requested.');
          await refreshJobs();
        } catch(e){
          notifyError('Cancel failed', e);
        }
      });
    });

    tbody.querySelectorAll('button[data-act="removeJob"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Remove this job from the queue/history? This cannot be undone.')) return;
        try{
          await run('Removing job…', 'api_removeJob', { jobId: btn.dataset.id });
          notifySuccess('Job removed.');
          await refreshJobs();
        } catch(e){
          notifyError('Remove failed', e);
        }
      });
    });
  }

  function updateFormsPager_(){
    const total = formsPage.total || 0;
    const start = total ? formsPage.offset + 1 : 0;
    const end = Math.min(total, formsPage.offset + formsPage.limit);
    $('formsPageMeta').textContent = total ? `${start}-${end} of ${total}` : '0 results';
    $('btnFormsPrev').disabled = formsPage.offset <= 0;
    $('btnFormsNext').disabled = formsPage.offset + formsPage.limit >= total;
    $('formsPager').style.display = formsPage.server ? '' : 'none';
  }

  function updateAgilePager_(){
    const total = agilePage.total || 0;
    const start = total ? agilePage.offset + 1 : 0;
    const end = Math.min(total, agilePage.offset + agilePage.limit);
    $('agilePageMeta').textContent = total ? `${start}-${end} of ${total}` : '0 results';
    $('btnAgilePrev').disabled = agilePage.offset <= 0;
    $('btnAgileNext').disabled = agilePage.offset + agilePage.limit >= total;
    $('agilePager').style.display = agilePage.server ? '' : 'none';
  }

  function formsShouldUseServer_(){
    const total = BOOT?.counts?.formsTotal ?? BOOT?.forms?.length ?? 0;
    return total > LARGE_DATA_THRESHOLD || (BOOT?.page?.next?.formsOffset !== null && BOOT?.page?.next?.formsOffset !== undefined);
  }

  function agileShouldUseServer_(){
    const total = BOOT?.indexState?.rows ?? BOOT?.counts?.agileLatestTotal ?? 0;
    return total > LARGE_DATA_THRESHOLD;
  }

  async function loadFormsPage(offset){
    if (!BOOT) return;
    formsPage.server = formsShouldUseServer_();
    formsPage.offset = Math.max(0, Number(offset || 0));
    filtersState.forms.query = $('formsSearch').value || '';
    filtersState.forms.status = $('formsStatusFilter').value || '';

    if (!formsPage.server) {
      formsPage.total = (BOOT.forms || []).length;
      renderForms(BOOT.forms || []);
      updateFormsPager_();
      return;
    }
    try {
      const res = await run('Loading forms…', 'api_listFilesTable', {
        type: 'FORM',
        query: filtersState.forms.query,
        status: filtersState.forms.status,
        offset: formsPage.offset,
        limit: formsPage.limit
      });
      formsPage.total = res.total || 0;
      formsPage.offset = res.offset || 0;
      renderForms(res.rows || [], { server: true, total: formsPage.total });
      updateFormsPager_();
    } catch (e) {
      notifyError('Loading forms failed', e);
    }
  }

  function refreshForms(){
    loadFormsPage(0);
  }

  function agileFilterPayload_(){
    return {
      site: $('agileFilterSite').value || '',
      part: $('agileFilterPart').value || '',
      tab: $('agileFilterTab').value || '',
      busway: $('agileFilterBusway').value || '',
      approval: $('agileFilterApproval').value || ''
    };
  }

  async function loadAgilePage(offset){
    if (!BOOT) return;
    agilePage.server = agileShouldUseServer_();
    agilePage.offset = Math.max(0, Number(offset || 0));

    if (!agilePage.server) {
      agilePage.total = (getAgileRowsForDisplay_() || []).length;
      renderAgileLatest(getAgileRowsForDisplay_());
      updateAgilePager_();
      return;
    }
    try {
      const res = await run('Loading Agile BOM…', 'api_listAgileIndex', {
        history: agileHistoryEnabled,
        filters: agileFilterPayload_(),
        offset: agilePage.offset,
        limit: agilePage.limit
      });
      agilePage.total = res.total || 0;
      agilePage.offset = res.offset || 0;
      if (res.options) BOOT.agileOptions = res.options;
      renderAgileLatest(res.rows || [], { server: true, total: agilePage.total });
      updateAgilePager_();
    } catch (e) {
      notifyError('Loading Agile BOM failed', e);
    }
  }


  function renderProjects(projects){
    const tbody = $('tblProjects').querySelector('tbody');
    tbody.innerHTML = '';

    $('projectsHint').textContent =
      'Select projects to schedule batch RELEASED. Eligibility depends on approvals and Settings (Require Approved Form/Agile).';

    const rows = projects || [];
    $('projectsCount').textContent = `${rows.length} project(s)`;

    if (!rows.length) {
      setStateWithBody('state-projects', 'body-projects', 'empty', { title: 'No projects loaded', body: 'Projects will appear once the dashboard data is synced.' });
      setTableEmpty(tbody, 6, 'No projects found.');
      return;
    }
    setStateWithBody('state-projects', 'body-projects', 'ready');

    rows.forEach(p => {
      const eligible = computeEligibility(p);
      const rel = p.latestReleased;
      const relStatus = escapeHtml(rel && rel.status ? rel.status : '');
      const relCell = rel ? `${fileLink(rel.url, `Rev ${rel.mbomRev}`)}<div class="mono">${relStatus}</div>` : '<span class="mono">—</span>';
      const projectKey = escapeHtml(p.projectKey);
      const clusterTab = agileTabLink(p.clusterTab, p.clusterTabUrl);
      const mdaTab = agileTabLink(p.mdaTab, p.mdaTabUrl);
      const clusterRev = escapeHtml(p.clusterRev || '');
      const mdaRev = escapeHtml(p.mdaRev || '');

      const tr = document.createElement('tr');
      if (eligible) tr.classList.add('project-eligible');
      if (p.hasNewAgileRevision) tr.classList.add('project-alert');
      tr.innerHTML = `
        <td><input type="checkbox" data-projchk="${projectKey}"></td>
        <td>
          <span class="pill ok">${projectKey}</span>
        </td>
        <td class="mono">${clusterRev ? `Rev ${clusterRev} • ${clusterTab}<br>${pill(p.clusterApproval)}` : '<span class="mono">—</span>'}</td>
        <td class="mono">${p.includeMda ? (mdaRev ? `Rev ${mdaRev} • ${mdaTab}<br>${pill(p.mdaApproval)}` : '<span class="mono">—</span>') : '<span class="mono">—</span>'}</td>
        <td>${relCell}</td>
        <td>${eligible ? '<span class="pill ok">Eligible</span>' : '<span class="pill warn">Blocked</span>'}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderProjectEdit(projects){
    const tbody = $('tblProjectEdit').querySelector('tbody');
    tbody.innerHTML = '';

    if (!projects || !projects.length) {
      setStateWithBody('state-edit', 'body-edit', 'empty', { title: 'No projects loaded', body: 'Projects will appear once the dashboard data is synced.' });
      setTableEmpty(tbody, 5, 'No projects found.');
      return;
    }
    setStateWithBody('state-edit', 'body-edit', 'ready');

    projects.forEach(p => {
      const projectKey = escapeHtml(p.projectKey);
      const clusterGroup = Number(p.clusterGroup || 1);
      const clusterBuswaySupplier = escapeHtml(p.clusterBuswaySupplier || '');
      const mdaBuswaySupplier = escapeHtml(p.mdaBuswaySupplier || '');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="pill ok">${projectKey}</span></td>
        <td>
          <select data-act="clusterGroup" data-project="${projectKey}">
            ${[1,2,3,4,5,6,7,8,9].map(n => `<option value="${n}" ${clusterGroup===n?'selected':''}>${n}</option>`).join('')}
          </select>
        </td>
        <td><input data-act="clusterBuswaySupplier" data-project="${projectKey}" value="${clusterBuswaySupplier}" placeholder="e.g., EAE, EI, Mardix"></td>
        <td><input data-act="mdaBuswaySupplier" data-project="${projectKey}" value="${mdaBuswaySupplier}" placeholder="e.g., Starline, EI"></td>
        <td><button class="btn primary" data-act="saveProject" data-project="${projectKey}">Save</button></td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button[data-act="saveProject"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        try{
          const projectKey = btn.dataset.project;
          const row = btn.closest('tr');
          const clusterGroup = row.querySelector('select[data-act="clusterGroup"]').value;
          const clusterBuswaySupplier = row.querySelector('input[data-act="clusterBuswaySupplier"]').value;
          const mdaBuswaySupplier = row.querySelector('input[data-act="mdaBuswaySupplier"]').value;
          await run('Updating project settings…', 'api_updateProjectSettings', {
            projectKey,
            clusterGroup: Number(clusterGroup),
            clusterBuswaySupplier,
            mdaBuswaySupplier
          });
          notifySuccess('Project settings updated.');
          if (BOOT && BOOT.loaded) BOOT.loaded.projects = false;
          await loadSections(['projects'], 'Refreshing projects…');
        } catch(e){
          notifyError('Project update failed', e);
        }
      });
    });
  }

  function renderForms(forms, opts){
    const tbody = $('tblForms').querySelector('tbody');
    tbody.innerHTML = '';
    const serverMode = opts && opts.server;

    const currentId = (BOOT.config.currentApprovedFormFileId || '').trim();

    const sourceForms = serverMode ? (forms || []) : applyFormsFiltersClient_(forms || []);
    $('formsCount').textContent = `${sourceForms.length} form(s)`;

    if (!sourceForms || !sourceForms.length) {
      setStateWithBody('state-forms', 'body-forms', 'empty', { title: 'No form revisions yet', body: 'Schedule a new revision to get started.' });
      setTableEmpty(tbody, 8, 'No form revisions found.');
      return;
    }
    setStateWithBody('state-forms', 'body-forms', 'ready');

    sourceForms.sort((a,b) => Number(b.mbomRev||0) - Number(a.mbomRev||0));
    sourceForms.forEach(f => {
      const isCurrent = currentId && (String(f.fileId).trim() === currentId);
      const fileId = escapeHtml(f.fileId);
      const rev = escapeHtml(f.mbomRev || '');
      const fileName = escapeHtml(f.fileName || '');
      const createdAt = escapeHtml(fmtDate(f.createdAt));
      const eco = escapeHtml(f.eco || '');
      const statusUpper = String(f.status || '').toUpperCase();
      const isObsolete = statusUpper === 'OBSOLETE';
      const canObsolete = !isCurrent && !isObsolete;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${rev}</td>
        <td>${pill(f.status)}</td>
        <td>${isCurrent ? pill('CURRENT') : '<span class="mono">—</span>'}</td>
        <td class="mono">${fileName || '—'}</td>
        <td>${fileLink(f.url,'Open')}</td>
        <td class="mono">${createdAt}</td>
        <td class="mono">${eco}</td>
        <td class="actionCell">
          ${statusUpper === 'APPROVED'
            ? '<button class="btn" disabled>Approved</button>'
            : `<button class="btn" data-act="approveForm" data-file="${fileId}">Approve</button>`
          }
          ${isCurrent
            ? '<button class="btn" disabled>Current</button>'
            : `<button class="btn primary" data-act="setCurrentApproved" data-file="${fileId}">Set Current</button>`
          }
          ${canObsolete
            ? `<button class="btn danger" data-act="obsoleteForm" data-file="${fileId}">Obsolete</button>`
            : '<button class="btn" disabled>Obsolete</button>'
          }
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button[data-act="approveForm"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        try {
          await run('Approving Form…','api_setFileStatus',{ fileId: btn.dataset.file, status: 'APPROVED' });
          notifySuccess('Form approved.');
          await bootstrap();
        } catch(e){
          notifyError('Form approval failed', e);
        }
      });
    });

    tbody.querySelectorAll('button[data-act="setCurrentApproved"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        try{
          await run('Setting current approved…','api_setApprovedFormFileId', btn.dataset.file);
          notifySuccess('Current approved form updated.');
          await bootstrap();
        } catch(e){
          notifyError('Update failed', e);
        }
      });
    });

    tbody.querySelectorAll('button[data-act="obsoleteForm"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Move this Form revision to Obsolete?')) return;
        try{
          await run('Obsoleting form…','api_obsoleteFormFile', { fileId: btn.dataset.file });
          notifySuccess('Form marked obsolete.');
          await bootstrap();
        } catch(e){
          notifyError('Obsolete failed', e);
        }
      });
    });
  }

  function renderFormSelectors(){
    const forms = (BOOT.forms || []).slice().sort((a,b)=>Number(b.mbomRev||0)-Number(a.mbomRev||0));
    const baseSelect = $('formBaseSelect');
    const relSelect = $('relFormSelect');
    if (baseSelect) baseSelect.innerHTML = '';
    if (relSelect) relSelect.innerHTML = '';

    const currentId = (BOOT.config.currentApprovedFormFileId || '').trim();
    const optionForForm = (f) => {
      const status = String(f.status || '').toUpperCase() || 'UNSET';
      return `Rev ${f.mbomRev} • ${status}`;
    };

    const fillSelect = (selectEl, includeCurrent) => {
      if (!selectEl) return;
      if (includeCurrent) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = `Use Current Approved (${currentId || 'not set'})`;
        selectEl.appendChild(opt);
      }
      forms.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.fileId;
        opt.textContent = optionForForm(f);
        if (currentId && f.fileId === currentId) opt.dataset.current = '1';
        selectEl.appendChild(opt);
      });
    };

    fillSelect(baseSelect, true);
    fillSelect(relSelect, true);

    if (baseSelect && currentId) {
      baseSelect.value = '';
    }
    if (relSelect && currentId) {
      relSelect.value = '';
    }

    updateFormBaseMeta();
    updateReleaseFormMeta();
    updateControlledReleaseMsg();
  }

  function updateFormBaseMeta(){
    const meta = $('formBaseMeta');
    const select = $('formBaseSelect');
    if (!meta || !select) return;
    setFieldError('formBaseId', 'formBaseError', '');
    const selectedId = select.value || '';
    const currentId = (BOOT.config.currentApprovedFormFileId || '').trim();
    const id = selectedId || currentId;
    const form = (BOOT.forms || []).find(f => String(f.fileId||'').trim() === String(id||'').trim());
    if (!form) {
      meta.textContent = selectedId ? 'Selected form not found in FILES.' : 'Using CURRENT_APPROVED_FORM_FILE_ID.';
      return;
    }
    meta.textContent = `Selected: Rev ${form.mbomRev} • ${form.status || 'UNSET'}${form.fileName ? ` • ${form.fileName}` : ''}`;
    if (!selectedId) {
      $('formBaseId').value = '';
    } else {
      $('formBaseId').value = selectedId;
    }
  }

  function updateReleaseFormMeta(){
    const meta = $('relFormMeta');
    const select = $('relFormSelect');
    if (!meta || !select) return;
    const selectedId = select.value || '';
    const currentId = (BOOT.config.currentApprovedFormFileId || '').trim();
    const id = selectedId || currentId;
    const form = (BOOT.forms || []).find(f => String(f.fileId||'').trim() === String(id||'').trim());
    if (!form) {
      meta.textContent = selectedId ? 'Selected form not found in FILES.' : 'Using CURRENT_APPROVED_FORM_FILE_ID.';
      return;
    }
    meta.textContent = `Selected: Rev ${form.mbomRev} • ${form.status || 'UNSET'}${form.fileName ? ` • ${form.fileName}` : ''}`;
  }

  function getAgileRowsForDisplay_(){
    if (agileHistoryEnabled) return BOOT.dashboard.agileAll || [];
    return BOOT.dashboard.agileLatest || [];
  }

  function updateAgileFilterOptions_(rows, options){
    const fill = (id, values, label) => {
      const select = $(id);
      if (!select) return;
      const current = select.value;
      select.innerHTML = `<option value="">${label}</option>` + values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
      if (current) select.value = current;
    };

    const sites = (options && options.sites) || Array.from(new Set((rows || []).map(r => String(r.site || '').trim()).filter(Boolean))).sort();
    const parts = (options && options.parts) || Array.from(new Set((rows || []).map(r => String(r.partNorm || '').trim()).filter(Boolean))).sort();
    const busways = (options && options.busways) || Array.from(new Set((rows || []).map(r => String(r.buswaySupplier || '').trim()).filter(Boolean))).sort();
    const approvals = (options && options.approvals) || Array.from(new Set((rows || []).map(r => String(r.approvalStatus || '').trim()).filter(Boolean))).sort();

    fill('agileFilterSite', sites, 'All Sites');
    fill('agileFilterPart', parts, 'All Parts');
    fill('agileFilterBusway', busways, 'All Busway');
    fill('agileFilterApproval', approvals, 'All Approvals');
  }

  function applyAgileFilters_(rows){
    const site = String($('agileFilterSite').value || '').trim();
    const part = String($('agileFilterPart').value || '').trim();
    const tab = String($('agileFilterTab').value || '').trim().toLowerCase();
    const busway = String($('agileFilterBusway').value || '').trim();
    const approval = String($('agileFilterApproval').value || '').trim();

    return (rows || []).filter(r => {
      if (site && String(r.site || '').trim() !== site) return false;
      if (part && String(r.partNorm || '').trim() !== part) return false;
      if (busway && String(r.buswaySupplier || '').trim() !== busway) return false;
      if (approval && String(r.approvalStatus || '').trim() !== approval) return false;
      if (tab) {
        const hay = String(r.tabName || '').toLowerCase();
        if (!hay.includes(tab)) return false;
      }
      return true;
    });
  }

  function renderAgileLatest(rows, opts){
    const tbody = $('tblAgileLatest').querySelector('tbody');
    tbody.innerHTML = '';
    $('agileHint').textContent = 'Approve latest Agile tabs to enable controlled RELEASED creation.';
    $('btnAgileToggleHistory').textContent = agileHistoryEnabled ? 'Show latest only' : 'Show history';

    const serverMode = opts && opts.server;
    if (!rows || !rows.length) {
      setStateWithBody('state-agile', 'body-agile', 'empty', { title: 'No Agile rows found', body: 'Latest Agile tabs will appear after indexing.' });
      setTableEmpty(tbody, 8, 'No Agile BOM data found.');
      return;
    }
    setStateWithBody('state-agile', 'body-agile', 'ready');

    updateAgileFilterOptions_(rows, BOOT.agileOptions);
    const filteredRows = serverMode ? rows : applyAgileFilters_(rows);
    if (!filteredRows.length) {
      setTableEmpty(tbody, 8, 'No Agile BOM data matches the filters.');
      return;
    }

    filteredRows.forEach(r => {
      const site = escapeHtml(r.site);
      const partNorm = escapeHtml(r.partNorm);
      const rev = escapeHtml(r.rev);
      const downloadDate = escapeHtml(r.downloadDate);
      const tabName = escapeHtml(r.tabName);
      const busway = escapeHtml(r.buswaySupplier || '');
      const status = String(r.approvalStatus || '').toUpperCase();
      const showApproveReject = status !== 'APPROVED';
      const showObsolete = status !== 'OBSOLETE';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${site}</td>
        <td class="mono">${partNorm}</td>
        <td class="mono">${rev}</td>
        <td class="mono">${downloadDate}</td>
        <td class="mono">${tabName}</td>
        <td class="mono">${busway}</td>
        <td>${pill(r.approvalStatus)}</td>
        <td>
          ${showApproveReject ? `<button class="btn" data-act="approveAgile" data-tab="${tabName}">Approve</button>
          <button class="btn danger" data-act="rejectAgile" data-tab="${tabName}">Reject</button>` : '<span class="mono">Approved</span>'}
          ${showObsolete ? `<button class="btn danger" data-act="obsoleteAgile" data-tab="${tabName}">Obsolete</button>` : '<span class="mono" style="margin-left:6px;">Obsolete</span>'}
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button[data-act="approveAgile"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const notes = prompt(`Approve Agile Tab:\n${btn.dataset.tab}\n\nNotes (optional):`, '') || '';
        try{
          await run('Approving Agile…','api_setAgileApproval',{ tabName: btn.dataset.tab, status:'APPROVED', notes });
          notifySuccess('Agile tab approved.');
          await reloadSections(['agileLatest', 'approvals', 'projects', 'forms'], 'Refreshing approvals…');
        }
        catch(e){ notifyError('Approval failed', e); }
      });
    });

    tbody.querySelectorAll('button[data-act="rejectAgile"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm(`Reject Agile tab "${btn.dataset.tab}"? This will block RELEASED scheduling.`)) return;
        const notes = prompt(`Reject Agile Tab:\n${btn.dataset.tab}\n\nReason:`, '') || '';
        try{
          await run('Rejecting Agile…','api_setAgileApproval',{ tabName: btn.dataset.tab, status:'REJECTED', notes });
          notifySuccess('Agile tab rejected.');
          await reloadSections(['agileLatest', 'approvals', 'projects', 'forms'], 'Refreshing approvals…');
        }
        catch(e){ notifyError('Rejection failed', e); }
      });
    });

    tbody.querySelectorAll('button[data-act="obsoleteAgile"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm(`Mark Agile tab "${btn.dataset.tab}" as obsolete?`)) return;
        const notes = prompt(`Obsolete Agile Tab:\n${btn.dataset.tab}\n\nNotes (optional):`, '') || '';
        try{
          await run('Obsoleting Agile…','api_setAgileApproval',{ tabName: btn.dataset.tab, status:'OBSOLETE', notes });
          notifySuccess('Agile tab marked obsolete.');
          await reloadSections(['agileLatest', 'approvals', 'projects', 'forms'], 'Refreshing approvals…');
        }
        catch(e){ notifyError('Obsolete failed', e); }
      });
    });

    renderAgileReviews(BOOT.dashboard?.pendingAgileReviews || []);
  }

  function renderAgileReviews(reviews){
    const tbodyR = $('tblAgileReviews')?.querySelector('tbody');
    if (!tbodyR) return;
    tbodyR.innerHTML = '';

    const list = Array.isArray(reviews) ? reviews : [];
    if (!list.length) {
      setTableEmpty(tbodyR, 8, 'No Agile BOM reviews pending.');
      return;
    }

    list.forEach(r => {
      const site = escapeHtml(r.site);
      const part = escapeHtml(r.partNorm || r.part || '');
      const rev = escapeHtml(r.rev);
      const tabName = escapeHtml(r.tabName);
      const projectType = escapeHtml(r.projectType || '');
      const issues = Array.isArray(r.exceptions) ? r.exceptions.length : 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${site}</td>
        <td class="mono">${part}</td>
        <td class="mono">${rev}</td>
        <td class="mono">${tabName}</td>
        <td class="mono">${projectType}</td>
        <td class="mono">${issues}</td>
        <td>${pill(r.status)}</td>
        <td>
          <button class="btn" data-act="reviewDetail" data-tab="${tabName}">View</button>
          <button class="btn primary" data-act="reviewApprove" data-tab="${tabName}">Approve</button>
          <button class="btn danger" data-act="reviewReject" data-tab="${tabName}">Reject</button>
        </td>
      `;
      tbodyR.appendChild(tr);
    });

    tbodyR.querySelectorAll('button[data-act="reviewDetail"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const review = list.find(r => String(r.tabName || '') === String(btn.dataset.tab || ''));
        if (!review) return;
        const issues = (review.exceptions || []).map(e => {
          const wp = e.workPackage ? ` ${e.workPackage}` : '';
          const cls = e.classification ? ` • ${e.classification}` : '';
          const gpn = e.gpn ? ` • ${e.gpn}` : '';
          const detail = e.message || e.type;
          return `- ${detail}${wp}${cls}${gpn} (expected ${e.expectedQty || 0}, actual ${e.actualQty || 0})`;
        }).join('\n');
        const summary = review.summary || {};
        const header = `Agile BOM Review\nTab: ${review.tabName}\nProject: ${review.projectKey || ''}\nType: ${review.projectType || ''}\nIssues: ${Array.isArray(review.exceptions) ? review.exceptions.length : 0}`;
        alert(`${header}\n\nTotals\nLines: ${summary.totalLines || 0}\nQty: ${summary.totalQty || 0}\nUnique GPN: ${summary.uniqueGpn || 0}\n\nIssues\n${issues || 'None'}`);
      });
    });

    tbodyR.querySelectorAll('button[data-act="reviewApprove"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const notes = prompt(`Approve Agile Review:\n${btn.dataset.tab}\n\nNotes (optional):`, '') || '';
        try{
          await run('Approving Agile review…','api_setAgileReviewStatus',{ tabName: btn.dataset.tab, status:'APPROVED', notes });
          notifySuccess('Agile review approved.');
          await reloadSections(['approvals', 'agileLatest', 'projects', 'forms'], 'Refreshing approvals…');
        }
        catch(e){ notifyError('Review approval failed', e); }
      });
    });

    tbodyR.querySelectorAll('button[data-act="reviewReject"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm(`Reject Agile review "${btn.dataset.tab}"?`)) return;
        const notes = prompt(`Reject Agile Review:\n${btn.dataset.tab}\n\nReason:`, '') || '';
        try{
          await run('Rejecting Agile review…','api_setAgileReviewStatus',{ tabName: btn.dataset.tab, status:'REJECTED', notes });
          notifySuccess('Agile review rejected.');
          await reloadSections(['approvals', 'agileLatest', 'projects', 'forms'], 'Refreshing approvals…');
        }
        catch(e){ notifyError('Review rejection failed', e); }
      });
    });
  }

  function renderApprovals(){
    // Agile approvals
    const tbodyA = $('tblPendingAgile').querySelector('tbody');
    tbodyA.innerHTML = '';

    const agile = BOOT.dashboard.agileLatest || [];
    const agileRows = agile.filter(x => String(x.approvalStatus).toUpperCase() !== 'APPROVED');

    agileRows.forEach(r => {
      const site = escapeHtml(r.site);
      const partNorm = escapeHtml(r.partNorm);
      const rev = escapeHtml(r.rev);
      const downloadDate = escapeHtml(r.downloadDate);
      const tabName = escapeHtml(r.tabName);
      const busway = escapeHtml(r.buswaySupplier || '');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${site}</td>
        <td class="mono">${partNorm}</td>
        <td class="mono">${rev}</td>
        <td class="mono">${downloadDate}</td>
        <td class="mono">${tabName}</td>
        <td class="mono">${busway}</td>
        <td>${pill(r.approvalStatus)}</td>
        <td><button class="btn" data-tab="${tabName}">Approve</button></td>
      `;
      tbodyA.appendChild(tr);
    });

    if (!agileRows.length) {
      setTableEmpty(tbodyA, 8, 'No Agile approvals pending.');
    }

    tbodyA.querySelectorAll('button[data-tab]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const notes = prompt(`Approve Agile Tab:\n${btn.dataset.tab}\n\nNotes (optional):`, '') || '';
        try{
          await run('Approving Agile…','api_setAgileApproval',{ tabName: btn.dataset.tab, status:'APPROVED', notes });
          notifySuccess('Agile tab approved.');
          await reloadSections(['agileLatest', 'approvals', 'projects', 'forms'], 'Refreshing approvals…');
        }
        catch(e){ notifyError('Approval failed', e); }
      });
    });

    // Agile BOM reviews
    const tbodyR = $('tblPendingAgileReviews').querySelector('tbody');
    tbodyR.innerHTML = '';

    const reviews = (BOOT.dashboard && Array.isArray(BOOT.dashboard.pendingAgileReviews))
      ? BOOT.dashboard.pendingAgileReviews
      : [];

    reviews.forEach(r => {
      const site = escapeHtml(r.site);
      const part = escapeHtml(r.partNorm || r.part || '');
      const rev = escapeHtml(r.rev);
      const tabName = escapeHtml(r.tabName);
      const projectType = escapeHtml(r.projectType || '');
      const issues = Array.isArray(r.exceptions) ? r.exceptions.length : 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${site}</td>
        <td class="mono">${part}</td>
        <td class="mono">${rev}</td>
        <td class="mono">${tabName}</td>
        <td class="mono">${projectType}</td>
        <td class="mono">${issues}</td>
        <td>${pill(r.status)}</td>
        <td>
          <button class="btn" data-act="reviewDetail" data-tab="${tabName}">View</button>
          <button class="btn primary" data-act="reviewApprove" data-tab="${tabName}">Approve</button>
          <button class="btn danger" data-act="reviewReject" data-tab="${tabName}">Reject</button>
        </td>
      `;
      tbodyR.appendChild(tr);
    });

    if (!reviews.length) {
      setTableEmpty(tbodyR, 8, 'No Agile BOM reviews pending.');
    }

    tbodyR.querySelectorAll('button[data-act="reviewDetail"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const review = reviews.find(r => String(r.tabName || '') === String(btn.dataset.tab || ''));
        if (!review) return;
        const issues = (review.exceptions || []).map(e => {
          const wp = e.workPackage ? ` ${e.workPackage}` : '';
          const cls = e.classification ? ` • ${e.classification}` : '';
          const gpn = e.gpn ? ` • ${e.gpn}` : '';
          const detail = e.message || e.type;
          return `- ${detail}${wp}${cls}${gpn} (expected ${e.expectedQty || 0}, actual ${e.actualQty || 0})`;
        }).join('\n');
        const summary = review.summary || {};
        const header = `Agile BOM Review\nTab: ${review.tabName}\nProject: ${review.projectKey || ''}\nType: ${review.projectType || ''}\nIssues: ${Array.isArray(review.exceptions) ? review.exceptions.length : 0}`;
        alert(`${header}\n\nTotals\nLines: ${summary.totalLines || 0}\nQty: ${summary.totalQty || 0}\nUnique GPN: ${summary.uniqueGpn || 0}\n\nIssues\n${issues || 'None'}`);
      });
    });

    tbodyR.querySelectorAll('button[data-act="reviewApprove"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const notes = prompt(`Approve Agile Review:\n${btn.dataset.tab}\n\nNotes (optional):`, '') || '';
        try{
          await run('Approving Agile review…','api_setAgileReviewStatus',{ tabName: btn.dataset.tab, status:'APPROVED', notes });
          notifySuccess('Agile review approved.');
          await reloadSections(['approvals', 'agileLatest', 'projects', 'forms'], 'Refreshing approvals…');
        }
        catch(e){ notifyError('Review approval failed', e); }
      });
    });

    tbodyR.querySelectorAll('button[data-act="reviewReject"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm(`Reject Agile review "${btn.dataset.tab}"?`)) return;
        const notes = prompt(`Reject Agile Review:\n${btn.dataset.tab}\n\nReason:`, '') || '';
        try{
          await run('Rejecting Agile review…','api_setAgileReviewStatus',{ tabName: btn.dataset.tab, status:'REJECTED', notes });
          notifySuccess('Agile review rejected.');
          await reloadSections(['approvals', 'agileLatest', 'projects', 'forms'], 'Refreshing approvals…');
        }
        catch(e){ notifyError('Review rejection failed', e); }
      });
    });

    // Form approvals
    const tbodyF = $('tblPendingForms').querySelector('tbody');
    tbodyF.innerHTML = '';

    const sourceForms = (BOOT.dashboard && Array.isArray(BOOT.dashboard.pendingForms) && BOOT.dashboard.pendingForms.length)
      ? BOOT.dashboard.pendingForms
      : (BOOT.forms || []);
    const forms = sourceForms.filter(f => String(f.status||'').trim().toUpperCase() === 'DRAFT');

    forms.sort((a,b)=>Number(b.mbomRev||0)-Number(a.mbomRev||0));
    forms.forEach(f => {
      const fileId = escapeHtml(f.fileId);
      const rev = escapeHtml(f.mbomRev);
      const fileName = escapeHtml(f.fileName || '');
      const createdAt = escapeHtml(fmtDate(f.createdAt));
      const eco = escapeHtml(f.eco || '');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${rev}</td>
        <td>${pill(f.status)}</td>
        <td class="mono">${fileName || '—'}</td>
        <td>${fileLink(f.url,'Open')}</td>
        <td class="mono">${createdAt}</td>
        <td class="mono">${eco}</td>
        <td><button class="btn primary" data-file="${fileId}">Mark APPROVED</button></td>
      `;
      tbodyF.appendChild(tr);
    });

    if (!forms.length) {
      setTableEmpty(tbodyF, 7, 'No Form approvals pending.');
    }

    const hasApprovals = agileRows.length || forms.length || reviews.length;
    if (!hasApprovals) {
      setStateWithBody('state-approvals', 'body-approvals', 'empty', { title: 'No approvals pending', body: 'You are all caught up.' });
    } else {
      setStateWithBody('state-approvals', 'body-approvals', 'ready');
    }

    tbodyF.querySelectorAll('button[data-file]').forEach(btn => {
      btn.addEventListener('click', async () => {
        try{
          await run('Approving Form…','api_setFileStatus',{ fileId: btn.dataset.file, status:'APPROVED' });
          notifySuccess('Form approved.');
          await reloadSections(['forms', 'approvals', 'projects', 'agileLatest'], 'Refreshing approvals…');
        } catch(e){
          notifyError('Form approval failed', e);
        }
      });
    });
  }

  function updateActionFilters(rows){
    const projects = Array.from(new Set((rows || []).map(r => String(r.projectName || '').trim()).filter(Boolean))).sort();
    const disciplines = Array.from(new Set((rows || []).map(r => String(r.discipline || '').trim()).filter(Boolean))).sort();
    const statuses = Array.from(new Set((rows || []).map(r => String(r.lifecycleStatus || '').trim()).filter(Boolean))).sort();
    const sources = Array.from(new Set((rows || []).map(r => String(r.sourceSheet || '').trim()).filter(Boolean))).sort();

    const fill = (id, values, label) => {
      const select = $(id);
      if (!select) return;
      const current = select.value;
      select.innerHTML = `<option value="">${label}</option>` + values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
      if (current) select.value = current;
    };

    fill('actionFilterProject', projects, 'All Projects');
    fill('actionFilterDiscipline', disciplines, 'All Disciplines');
    fill('actionFilterStatus', statuses, 'All Statuses');
    fill('actionFilterSource', sources, 'All Sources');
  }

  function renderChangeActions(rows){
    const tbody = $('tblActions').querySelector('tbody');
    tbody.innerHTML = '';
    const filter = String($('actionFilter').value || '').trim().toLowerCase();
    const projectFilter = String($('actionFilterProject').value || '').trim();
    const disciplineFilter = String($('actionFilterDiscipline').value || '').trim();
    const statusFilter = String($('actionFilterStatus').value || '').trim();
    const sourceFilter = String($('actionFilterSource').value || '').trim();
    const filtered = (rows || []).filter(r => {
      if (projectFilter && String(r.projectName || '').trim() !== projectFilter) return false;
      if (disciplineFilter && String(r.discipline || '').trim() !== disciplineFilter) return false;
      if (statusFilter && String(r.lifecycleStatus || '').trim() !== statusFilter) return false;
      if (sourceFilter && String(r.sourceSheet || '').trim() !== sourceFilter) return false;
      if (!filter) return true;
      const hay = [
        r.actionNb, r.actionTitle, r.projectName, r.workPackage,
        r.discipline, r.lifecycleStatus, r.sourceSheet, r.referenceFile
      ].join(' ').toLowerCase();
      return hay.includes(filter);
    });

    if (rows && rows.length) {
      $('actionsMeta').textContent = `Showing ${filtered.length} of ${rows.length} actions.`;
    }

    if (!filtered.length) {
      setTableEmpty(tbody, 8, 'No actions found.');
      return;
    }

    filtered.forEach((r, idx) => {
      const title = escapeHtml(r.actionTitle || '');
      const actionRef = actionRefKey_(r);
      const link = actionRowLink_(r);
      const safeActionRef = escapeHtml(actionRef || '');
      const safeLink = escapeHtml(link || '');
      const isSelected = !!actionRef && selectedActionRefs.has(actionRef);
      const actionCell = (actionRef && link)
        ? `<a href="${safeLink}" target="_blank" rel="noopener">${safeActionRef}</a>`
        : (safeActionRef || '—');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${actionCell}</td>
        <td title="${title}">${title}</td>
        <td class="mono">${escapeHtml(r.projectName || '')}</td>
        <td class="mono">${escapeHtml(r.workPackage || '')}</td>
        <td class="mono">${escapeHtml(r.discipline || '')}</td>
        <td class="mono">${escapeHtml(r.lifecycleStatus || '')}</td>
        <td class="mono">${escapeHtml(r.sourceSheet || '')}</td>
        <td><button class="btn ${isSelected ? 'primary' : ''}" data-act="pickAction" data-idx="${idx}" ${actionRef ? '' : 'disabled'}>${isSelected ? 'Selected' : 'Add'}</button></td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button[data-act="pickAction"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.dataset.idx || 0);
        const row = filtered[idx];
        if (!row) return;
        const ref = actionRefKey_(row);
        if (!ref) return;
        if (selectedActionRefs.has(ref)) {
          selectedActionRefs.delete(ref);
          toast('info', `Removed action ${ref}.`);
        } else {
          selectedActionRefs.add(ref);
          if (row.actionTitle && !$('formDesc').value.trim()) {
            $('formDesc').value = row.actionTitle;
          }
          toast('success', `Added action ${ref}.`);
        }
        updateSelectedActionRefs_();
        renderChangeActions(changeActionsCache);
      });
    });
  }

  function renderConfig(rows){
    const tbody = $('tblConfig').querySelector('tbody');
    tbody.innerHTML = '';

    if (!rows || !rows.length) {
      setStateWithBody('state-settings', 'body-settings', 'empty', { title: 'No configuration rows found', body: 'Configuration values will appear after loading.' });
      setTableEmpty(tbody, 2, 'No configuration data.');
      return;
    }
    setStateWithBody('state-settings', 'body-settings', 'ready');

    rows.forEach(r => {
      const key = escapeHtml(r.key);
      const value = escapeHtml(String(r.value || ''));
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="mono">${key}</td><td><input data-key="${key}" value="${value}"></td>`;
      tbody.appendChild(tr);
    });

    $('settingsHint').innerHTML =
      `Web App URL: <span class="mono">${escapeHtml(BOOT.webAppUrl || '(not deployed)')}</span><br>
       Logos: set COMPANY_LOGO_URL and CUSTOMER_LOGO_URL in CONFIG.`;
  }

  function renderNotif(rows, status){
    const tbody = $('tblNotif').querySelector('tbody');
    tbody.innerHTML = '';

    if (!rows || !rows.length) {
      setStateWithBody('state-notifications', 'body-notifications', 'empty', { title: 'No notification settings found', body: 'Notification configuration will appear after loading.' });
      setTableEmpty(tbody, 3, 'No notification settings.');
      return;
    }
    setStateWithBody('state-notifications', 'body-notifications', 'ready');

    rows.forEach(r => {
      const key = escapeHtml(r.key);
      const value = escapeHtml(String(r.value || ''));
      const desc = escapeHtml(String(r.desc || ''));
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${key}</td>
        <td><input data-key="${key}" value="${value}"></td>
        <td class="mono">${desc}</td>
      `;
      tbody.appendChild(tr);
    });

    $('notifStatus').textContent =
      `RELEASED queue: ${status.releasedQueueCount} • last sent: ${status.releasedLastSentAt || '—'} • next scheduled: ${status.releasedNextSendAt || '—'}`;
  }

  // Create RELEASED page: populate + enforce eligibility + hide MDA when not required
  function populateProjectsDropdown(projects){
    $('relProject').innerHTML = '';
    $('pdProject').innerHTML = '';
    if (!projects || !projects.length) {
      setStateWithBody('state-create-released', 'body-create-released', 'empty', { title: 'No projects available', body: 'Load projects on the Dashboard to schedule RELEASED.' });
      setStateWithBody('state-project-data', 'body-project-data', 'empty', { title: 'No projects loaded', body: 'Load project data from the Dashboard first.' });
      return;
    }
    setStateWithBody('state-create-released', 'body-create-released', 'ready');
    setStateWithBody('state-project-data', 'body-project-data', 'ready');

    projects.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.projectKey;
      opt.textContent = p.projectKey;
      $('relProject').appendChild(opt);

      const opt2 = document.createElement('option');
      opt2.value = p.projectKey;
      opt2.textContent = p.projectKey;
      $('pdProject').appendChild(opt2);
    });
  }

  async function refreshReleaseSelectors(){
    const p = currentProject();
    if (!p) return;

    const setLoading = (selectEl, label) => {
      if (!selectEl) return;
      selectEl.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = label;
      selectEl.appendChild(opt);
    };

    $('relProjectMeta').textContent = `Site: ${p.site} • ClusterGroup: ${p.clusterGroup || '—'} • MDA Required: ${p.includeMda ? 'YES' : 'NO'}`;

    // Hide MDA blocks entirely when not required (ClusterGroup != 1)
    $('mdaBlock').style.display = p.includeMda ? '' : 'none';
    $('mdaBuswayBlock').style.display = p.includeMda ? '' : 'none';

    try {
      cacheClusterRows = [];
      cacheMdaRows = [];
      setLoading($('relClusterTab'), 'Loading Agile tabs…');
      $('relClusterMeta').textContent = 'Loading Agile tabs…';
      $('relClusterBusway').textContent = '';
      $('relClusterBuswayCode').textContent = '';
      if (p.includeMda) {
        setLoading($('relMdaTab'), 'Loading Agile tabs…');
        $('relMdaMeta').textContent = 'Loading Agile tabs…';
        $('relMdaBusway').textContent = '';
        $('relMdaBuswayCode').textContent = '';
      }

      const clusterPart = `Zone ${p.zone}`;
      const clusterRes = await callApi('api_listAgileTabs', { site: p.site, part: clusterPart });
      cacheClusterRows = (clusterRes && Array.isArray(clusterRes.rows)) ? clusterRes.rows : [];
      fillAgileSelect($('relClusterTab'), cacheClusterRows, p.clusterTab);

      if (p.includeMda) {
        const mdaRes = await callApi('api_listAgileTabs', { site: p.site, part: 'MDA' });
        cacheMdaRows = (mdaRes && Array.isArray(mdaRes.rows)) ? mdaRes.rows : [];
        fillAgileSelect($('relMdaTab'), cacheMdaRows, p.mdaTab);
      } else {
        cacheMdaRows = [];
        $('relMdaTab').innerHTML = '';
        $('relMdaMeta').textContent = '';
        $('relMdaBusway').textContent = '';
        $('relMdaBuswayCode').textContent = '';
      }

      updateAgileMeta();
      updateBuswaySuggestions();
      updateEcoSummary();
      updateReleaseFormMeta();
      await updateControlledReleaseMsg();
      clearFieldErrors([
        { input: 'relProject', error: 'relProjectError' },
        { input: 'relFormSelect', error: 'relFormError' },
        { input: 'relClusterTab', error: 'relClusterError' },
        { input: 'relMdaTab', error: 'relMdaError' }
      ]);
    } catch(e) {
      notifyError('Loading Agile selections failed', e);
    }
  }


  function fillAgileSelect(selectEl, rows, preferredTab){
    selectEl.innerHTML = '';
    if (!rows || !rows.length) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No Agile tabs available';
      selectEl.appendChild(opt);
      return;
    }
    rows.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.tabName;
      opt.textContent = `${formatAgileTabName(r.tabName)} • Rev ${r.rev} • ${r.approvalStatus}`;
      if (preferredTab && r.tabName === preferredTab) opt.selected = true;
      selectEl.appendChild(opt);
    });
    if (!selectEl.value && rows.length) selectEl.value = rows[0].tabName;
  }

  function findRow(rows, tab){ return (rows||[]).find(r => r.tabName === tab) || null; }

  function updateAgileMeta(){
    const c = findRow(cacheClusterRows, $('relClusterTab').value);
    if (c) $('relClusterMeta').innerHTML = `Selected: Rev ${escapeHtml(c.rev)} • ${escapeHtml(c.downloadDate)} • ${pill(c.approvalStatus)}`;
    else $('relClusterMeta').textContent = 'No Agile tab selected.';

    const p = currentProject();
    if (p && p.includeMda) {
      const m = findRow(cacheMdaRows, $('relMdaTab').value);
      if (m) $('relMdaMeta').innerHTML = `Selected: Rev ${escapeHtml(m.rev)} • ${escapeHtml(m.downloadDate)} • ${pill(m.approvalStatus)}`;
      else $('relMdaMeta').textContent = 'No Agile tab selected.';
    }
  }

  function updateEcoSummary(){
    const c = findRow(cacheClusterRows, $('relClusterTab').value);
    const p = currentProject();
    const ecos = [];
    if (c && c.eco) ecos.push(String(c.eco || '').trim());
    if (p && p.includeMda) {
      const m = findRow(cacheMdaRows, $('relMdaTab').value);
      if (m && m.eco) ecos.push(String(m.eco || '').trim());
    }
    const unique = Array.from(new Set(ecos.filter(Boolean)));
    $('relEco').value = unique.join(' / ');
  }

  function inferMdaKey(s){
    s = String(s||'').toUpperCase();
    if (s.includes('STARLINE')) return 'ST';
    if (s.includes('EI') || s.includes('E&I')) return 'EI';
    return '';
  }
  function inferClusterKey(s){
    s = String(s||'').toUpperCase();
    if (s.includes('MARDIX')) return 'MA';
    if (s.includes('EAE')) return 'EA';
    if (s.includes('EI') || s.includes('E&I')) return 'EI';
    return '';
  }

  function updateBuswaySuggestions(){
    const p = currentProject();
    const c = findRow(cacheClusterRows, $('relClusterTab').value);
    const clusterSupplier = (p && p.clusterBuswaySupplier) ? p.clusterBuswaySupplier : (c ? c.buswaySupplier : '');
    $('relClusterBusway').textContent = clusterSupplier ? `Supplier: ${clusterSupplier}` : 'Supplier: (blank)';
    const clusterCode = inferClusterKey(clusterSupplier);
    $('relClusterBuswayCode').textContent = clusterCode ? `Busway Code: ${clusterCode}` : 'Busway Code: (blank)';

    if (p && p.includeMda) {
      const m = findRow(cacheMdaRows, $('relMdaTab').value);
      const mdaSupplier = p.mdaBuswaySupplier ? p.mdaBuswaySupplier : (m ? m.buswaySupplier : '');
      $('relMdaBusway').textContent = mdaSupplier ? `Supplier: ${mdaSupplier}` : 'Supplier: (blank)';
      const mdaCode = inferMdaKey(mdaSupplier);
      $('relMdaBuswayCode').textContent = mdaCode ? `Busway Code: ${mdaCode}` : 'Busway Code: (blank)';
    } else {
      $('relMdaBusway').textContent = '';
      $('relMdaBuswayCode').textContent = '';
    }
  }

  async function updateControlledReleaseMsg(){
    const p = currentProject();
    if (!p) return;

    let ok = true;
    let reasons = [];

    if (BOOT.config.requireApprovedForm) {
      const selectedId = $('relFormSelect').value || BOOT.config.currentApprovedFormFileId || '';
      const form = (BOOT.forms || []).find(f => String(f.fileId || '').trim() === String(selectedId || '').trim());
      if (!selectedId) {
        ok = false;
        reasons.push('No Form selected.');
      } else if (!form || String(form.status || '').toUpperCase() !== 'APPROVED') {
        ok = false;
        reasons.push('Selected Form is not APPROVED.');
      }
    }

    if (BOOT.config.requireApprovedAgile) {
      const c = findRow(cacheClusterRows, $('relClusterTab').value);
      if (!c || String(c.approvalStatus).toUpperCase() !== 'APPROVED') { ok = false; reasons.push('Cluster Agile not approved.'); }
      if (p.includeMda) {
        const m = findRow(cacheMdaRows, $('relMdaTab').value);
        if (!m || String(m.approvalStatus).toUpperCase() !== 'APPROVED') { ok = false; reasons.push('MDA Agile not approved.'); }
      }
    }

    $('btnScheduleReleased').disabled = !ok;
    $('relControlMsg').textContent = ok ? 'Ready to schedule.' : ('Blocked: ' + reasons.join(' '));
  }

  function renderProjectTree(data){
    if (!data) {
      setState('state-project-tree', 'empty', { title: 'No project data', body: 'Select a project to view details.' });
      $('projectTree').innerHTML = '';
      return;
    }
    setState('state-project-tree', 'ready');

    const projectKey = escapeHtml(data.projectKey || '');
    const site = escapeHtml(data.site || '');
    const clusterGroup = escapeHtml(String(data.clusterGroup || ''));
    const includeMda = data.includeMda ? 'YES' : 'NO';

    const agileTable = (rows) => {
      if (!rows || !rows.length) return '<span class="mono">—</span>';
      return `
        <table class="table resizable">
          <thead><tr><th>Rev</th><th>Date</th><th>Tab</th><th>Busway</th><th>Approval</th><th>ECO</th></tr></thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td class="mono">${escapeHtml(r.rev)}</td>
                <td class="mono">${escapeHtml(r.downloadDate)}</td>
                <td class="mono">${escapeHtml(r.tabName)}</td>
                <td class="mono">${escapeHtml(r.buswaySupplier || '')}</td>
                <td>${pill(r.approvalStatus)}</td>
                <td class="mono">${escapeHtml(r.eco || '')}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    };

    const releasedTable = (rows) => {
      if (!rows || !rows.length) return '<span class="mono">—</span>';
      return `
        <table class="table resizable">
          <thead><tr><th>Rev</th><th>Status</th><th>File Name</th><th>File</th><th>ClusterTab</th><th>MDATab</th><th>Created</th></tr></thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td class="mono">${escapeHtml(r.mbomRev)}</td>
                <td>${pill(r.status)}</td>
                <td class="mono">${escapeHtml(r.fileName || '')}</td>
                <td>${fileLink(r.url,'Open')}</td>
                <td class="mono">${escapeHtml(r.agileTabCluster || '')}</td>
                <td class="mono">${escapeHtml(r.agileTabMDA || '')}</td>
                <td class="mono">${escapeHtml(fmtDate(r.createdAt))}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    };

    $('projectTree').innerHTML = `
      <div class="banner">
        Project: <b>${projectKey}</b> • Site: <b>${site}</b> • ClusterGroup: <b>${clusterGroup}</b> • Include MDA: <b>${includeMda}</b>
      </div>

      <details open style="margin-top:10px;">
        <summary class="mono">RELEASED history</summary>
        ${releasedTable(data.released || [])}
      </details>

      <details open style="margin-top:10px;">
        <summary class="mono">Agile Cluster history</summary>
        ${agileTable(data.clusterAgile || [])}
      </details>

      ${data.includeMda ? `
      <details open style="margin-top:10px;">
        <summary class="mono">Agile MDA history</summary>
        ${agileTable(data.mdaAgile || [])}
      </details>` : ''}
    `;
  }

  function renderNotifTable(){
    renderNotif(BOOT.notifications.settings || [], BOOT.notifications.status || {});
  }

  async function reloadSections(sections, label){
    if (!BOOT) return;
    BOOT.loaded = BOOT.loaded || {};
    const targets = Array.isArray(sections) ? sections : [];
    targets.forEach(s => { delete BOOT.loaded[s]; });
    await loadSections(targets, label);
  }

  async function loadSections(sections, label){
    BOOT.loaded = BOOT.loaded || {};
    const expanded = new Set(sections || []);
    if (expanded.has('approvals')) {
      expanded.add('forms');
      expanded.add('agileLatest');
    }

    const missing = Array.from(expanded).filter(s => !BOOT.loaded[s]);
    if (!missing.length) return;

    missing.forEach(s => {
      if (s === 'projects') setStateWithBody('state-projects', 'body-projects', 'loading', { title: 'Loading projects', body: 'Fetching the latest project list.' });
      if (s === 'projects') setStateWithBody('state-edit', 'body-edit', 'loading', { title: 'Loading project settings', body: 'Preparing editable project settings.' });
      if (s === 'forms') setStateWithBody('state-forms', 'body-forms', 'loading', { title: 'Loading forms', body: 'Fetching form revisions.' });
      if (s === 'agileLatest') setStateWithBody('state-agile', 'body-agile', 'loading', { title: 'Loading Agile BOM', body: 'Fetching latest Agile tabs.' });
      if (s === 'agileAll') setStateWithBody('state-agile', 'body-agile', 'loading', { title: 'Loading Agile BOM', body: 'Fetching Agile history.' });
      if (s === 'approvals') setStateWithBody('state-approvals', 'body-approvals', 'loading', { title: 'Loading approvals', body: 'Fetching approval queues.' });
      if (s === 'jobs') setStateWithBody('state-jobs', 'body-jobs', 'loading', { title: 'Loading jobs', body: 'Fetching queue summary.' });
      if (s === 'config') setStateWithBody('state-settings', 'body-settings', 'loading', { title: 'Loading settings', body: 'Fetching configuration values.' });
      if (s === 'notifications') setStateWithBody('state-notifications', 'body-notifications', 'loading', { title: 'Loading notifications', body: 'Fetching notification settings.' });
    });

    let data = null;
    try {
      data = await run(label || 'Loading data…', 'api_loadData', {
        sections: missing,
        jobsLimit: 30,
        limitForms: 200,
        limitReleases: 200,
        limitAgileLatest: 300
      });
    } catch (e) {
      missing.forEach(s => {
        if (s === 'projects') setStateWithBody('state-projects', 'body-projects', 'error', { title: 'Unable to load projects', body: formatErrorMessage(e) });
        if (s === 'projects') setStateWithBody('state-edit', 'body-edit', 'error', { title: 'Unable to load project settings', body: formatErrorMessage(e) });
        if (s === 'forms') setStateWithBody('state-forms', 'body-forms', 'error', { title: 'Unable to load forms', body: formatErrorMessage(e) });
        if (s === 'agileLatest') setStateWithBody('state-agile', 'body-agile', 'error', { title: 'Unable to load Agile BOM', body: formatErrorMessage(e) });
        if (s === 'agileAll') setStateWithBody('state-agile', 'body-agile', 'error', { title: 'Unable to load Agile BOM', body: formatErrorMessage(e) });
        if (s === 'approvals') setStateWithBody('state-approvals', 'body-approvals', 'error', { title: 'Unable to load approvals', body: formatErrorMessage(e) });
        if (s === 'jobs') setStateWithBody('state-jobs', 'body-jobs', 'error', { title: 'Unable to load jobs', body: formatErrorMessage(e) });
        if (s === 'config') setStateWithBody('state-settings', 'body-settings', 'error', { title: 'Unable to load settings', body: formatErrorMessage(e) });
        if (s === 'notifications') setStateWithBody('state-notifications', 'body-notifications', 'error', { title: 'Unable to load notifications', body: formatErrorMessage(e) });
      });
      throw e;
    }

    if (!data || typeof data !== 'object') {
      throw new Error('api_loadData returned empty/invalid response (null/undefined).');
    }

    if (data.dashboard) {
      BOOT.dashboard = { ...(BOOT.dashboard || {}), ...(data.dashboard || {}) };
    }
    if (data.diag && data.diag.counts) {
      BOOT.counts = data.diag.counts;
    }
    if (data.page) {
      BOOT.page = data.page;
    }
    if (missing.includes('forms')) {
      BOOT.forms = data.forms || [];
      renderForms(BOOT.forms || []);
      renderFormSelectors();
      formsPage.total = BOOT.counts?.formsTotal ?? BOOT.forms.length;
      formsPage.server = formsShouldUseServer_();
      updateFormsPager_();
    }
    if (missing.includes('releases')) {
      BOOT.releases = data.releases || [];
    }
    if (missing.includes('agileLatest')) {
      renderAgileLatest(getAgileRowsForDisplay_());
      agilePage.total = BOOT.counts?.agileLatestTotal ?? (getAgileRowsForDisplay_() || []).length;
      agilePage.server = agileShouldUseServer_();
      updateAgilePager_();
    }
    if (missing.includes('agileAll')) {
      renderAgileLatest(getAgileRowsForDisplay_());
      agilePage.total = BOOT.counts?.agileAllTotal ?? (getAgileRowsForDisplay_() || []).length;
      agilePage.server = agileShouldUseServer_();
      updateAgilePager_();
    }
    if (missing.includes('projects')) {
      renderProjects(BOOT.dashboard.projects || []);
      renderProjectEdit(BOOT.dashboard.projects || []);
      populateProjectsDropdown(BOOT.dashboard.projects || []);
      await refreshReleaseSelectors();
    }
    if (missing.includes('jobs')) {
      BOOT.jobs = data.jobs || BOOT.jobs;
      renderJobsTop();
      renderJobsTable(BOOT.jobs.recent || []);
      scheduleJobsPolling();
    }
    if (missing.includes('config')) {
      BOOT.configList = data.configList || [];
      renderConfig(BOOT.configList || []);
    }
    if (missing.includes('notifications')) {
      BOOT.notifications = data.notifications || { status: {}, settings: [] };
      if (typeof renderNotifTable === 'function') renderNotifTable();
    }
    if (expanded.has('approvals')) {
      renderApprovals();
    }

    missing.forEach(s => { BOOT.loaded[s] = true; });
    if (expanded.has('approvals')) BOOT.loaded.approvals = true;
  }

  async function bootstrap() {
    try {
      setStateWithBody('state-jobs', 'body-jobs', 'loading', { title: 'Loading jobs', body: 'Preparing job summary.' });
      setStateWithBody('state-projects', 'body-projects', 'loading', { title: 'Loading projects', body: 'Preparing project list.' });
      setStateWithBody('state-create-form', 'body-create-form', 'ready');
      setStateWithBody('state-create-released', 'body-create-released', 'loading', { title: 'Loading projects', body: 'Preparing RELEASED inputs.' });
      setStateWithBody('state-project-data', 'body-project-data', 'loading', { title: 'Loading projects', body: 'Preparing project list.' });
      setState('state-project-tree', 'empty', { title: 'Select a project', body: 'Choose a project to view its history.' });
      setStateWithBody('state-import', 'body-import', 'ready');
      setStateWithBody('state-readme', 'body-readme', 'ready');

      // Phase 1: fast bootstrap
      const boot = await run('Loading app…', 'api_bootstrap');
      if (!boot || typeof boot !== 'object') throw new Error('api_bootstrap returned empty/invalid response.');

      BOOT = BOOT || {};
      BOOT.user = boot.user;
      BOOT.webAppUrl = boot.webAppUrl;
      BOOT.config = boot.config;
      BOOT.indexState = boot.indexState;
      BOOT.jobs = { summary: boot.jobsSummary?.summary || {}, runningJob: boot.jobsSummary?.runningJob || null, recent: [] };
      BOOT.loaded = {};

      $('sub').textContent =
        `User: ${BOOT.user || '(unknown)'} • Require Form: ${BOOT.config?.requireApprovedForm} • Require Agile: ${BOOT.config?.requireApprovedAgile}`;

      setLogo($('logoCompany'), BOOT.config?.companyLogoUrl || '');
      setLogo($('logoCustomer'), BOOT.config?.customerLogoUrl || '');

      // Minimal rendering to avoid blank screen
      if (typeof renderJobsTop === 'function') renderJobsTop();

      await loadSections(['projects', 'jobs'], 'Loading data…');
      renderDiagnostics();

    } catch (e) {
      setBusy(false, '');
      $('sub').textContent = 'Error during loading.';
      notifyError('Startup failed', e);
      console.error(e);
    }
  }


  // Helper for safe error rendering
  function escapeHtml(s){
    return String(s||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }



  function scheduleJobsPolling(){
    if (jobsPollTimer) clearInterval(jobsPollTimer);
    jobsPollTimer = setInterval(async () => {
      const auto = $('chkAutoJobs') ? $('chkAutoJobs').checked : true;
      if (!auto) return;

      // Poll only if there are running/queued jobs
      const running = BOOT.jobs.summary.running;
      const queued = BOOT.jobs.summary.queued;
      if (running + queued <= 0) return;

      try {
        await refreshJobs();
      } catch(e) {
        const now = Date.now();
        if (now - lastPollErrorAt > 30000) {
          lastPollErrorAt = now;
          notifyError('Auto-refresh jobs failed', e);
        }
      }
    }, 4000);
  }

  function registerShortcuts(){
    document.addEventListener('keydown', (e) => {
      if (e.defaultPrevented) return;
      const target = e.target;
      const isTyping = target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT');
      const key = e.key.toLowerCase();

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const pageId = getActivePageId();
        if (pageId === 'page-createMbom') {
          const activeForm = $('page-createMbom').classList.contains('active');
          if (activeForm) {
            if (document.activeElement && document.activeElement.closest('#body-create-form')) {
              $('btnScheduleForm')?.click();
              e.preventDefault();
              return;
            }
            if (document.activeElement && document.activeElement.closest('#body-create-released')) {
              $('btnScheduleReleased')?.click();
              e.preventDefault();
              return;
            }
          }
        }
      }

      if (e.altKey && e.shiftKey) {
        if (key === 'a') { $('btnRefreshAgile')?.click(); e.preventDefault(); return; }
        if (key === 'd') { $('btnRefreshData')?.click(); e.preventDefault(); return; }
        if (key === 'f') { $('btnFullscreen')?.click(); e.preventDefault(); return; }
      }

      if (!isTyping && (key === '/' || (e.ctrlKey || e.metaKey) && key === 'k')) {
        if (focusPrimarySearch()) {
          e.preventDefault();
        }
      }
    });
  }

  bootstrap();
  registerShortcuts();

</script>
</body>
</html>
